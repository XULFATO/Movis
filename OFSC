Private Sub VincularBotonesForzado(wb As Workbook)
    Dim ws As Worksheet
    Dim shp As Shape
    Dim sAcc As String
    Dim sSub As String
    Dim sNew As String
    
    ' Recorremos cada hoja del libro de destino
    For Each ws In wb.Worksheets
        ' Recorremos cada objeto (botón, imagen, forma)
        For Each shp In ws.Shapes
            
            ' Intentamos leer la acción asignada
            On Error Resume Next
            sAcc = shp.OnAction
            On Error GoTo 0
            
            If sAcc <> "" Then
                ' 1. Limpiar el nombre del libro de origen si existe (separa en el "!")
                If InStr(sAcc, "!") > 0 Then
                    sSub = Mid(sAcc, InStr(sAcc, "!") + 1)
                Else
                    sSub = sAcc
                End If
                
                ' 2. Eliminar comillas simples molestas
                sSub = Replace(sSub, "'", "")
                
                ' 3. Buscar si esta macro fue ofuscada (VBA_X...)
                sNew = ObtenerNuevoNombre(sSub)
                
                ' 4. Si no se ofuscó, usamos el nombre original limpio
                If sNew = "" Then 
                    sNew = sSub
                End If
                
                ' 5. REASIGNACIÓN MAESTRA:
                ' Forzamos el enlace al nuevo libro usando comillas para evitar errores de espacios
                On Error Resume Next
                shp.OnAction = "'" & wb.Name & "'!" & sNew
                On Error GoTo 0
            End If
            
        Next shp
    Next ws
End Sub
