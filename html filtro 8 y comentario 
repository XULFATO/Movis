Sub ExtraerComentariosJson()
    Dim fso As Object, folder As Object, file As Object
    Dim txt As String, regex As Object, match As Object
    Dim p As Long, comment As String, cleanComment As String
    Dim jsonText As String, firstItem As Boolean, nombreSinExt As String
    
    ' üìÅ Carpeta donde est√°n los .htm
    Const rutaCarpeta As String = "C:\Users\TuUsuario\CarpetaHTML"  ' ‚ö†Ô∏è CAMBIA ESTA RUTA

    Set fso = CreateObject("Scripting.FileSystemObject")
    Set folder = fso.GetFolder(rutaCarpeta)
    Set regex = CreateObject("VBScript.RegExp")
    regex.IgnoreCase = True
    regex.Global = False
    regex.Pattern = "comentarios\s*a\s*las\s*tablas\s*del\s*vr"

    jsonText = "["
    firstItem = True

    For Each file In folder.Files
        If LCase(fso.GetExtensionName(file.Name)) = "htm" Then
            txt = fso.OpenTextFile(file.Path, 1, False).ReadAll
            txt = Replace(txt, "<", " <")
            txt = Replace(txt, ">", "> ")

            If regex.Test(txt) Then
                Set match = regex.Execute(txt)(0)
                p = match.FirstIndex + match.Length + 1
                comment = Mid(txt, p)

                ' üîπ Eliminar etiquetas HTML iniciales
                cleanComment = LimpiarComentario(comment)

                ' üîπ Quitar extensi√≥n .htm
                nombreSinExt = fso.GetBaseName(file.Name)

                ' üîπ Crear JSON limpio
                If Not firstItem Then jsonText = jsonText & "," & vbCrLf
                jsonText = jsonText & _
                    "{""file"":""" & JsonEscape(nombreSinExt) & """,""comments"":""" & JsonEscape(cleanComment) & """}"
                firstItem = False
            End If
        End If
    Next

    jsonText = jsonText & "]"

    ' üì§ Poner el JSON completo en celdas de Excel (dividido si es muy largo)
    Dim pos As Long, fila As Long, chunk As String
    pos = 1
    fila = 1
    Do While pos <= Len(jsonText)
        chunk = Mid(jsonText, pos, 30000)
        ThisWorkbook.Sheets(1).Cells(fila, 1).Value = chunk
        pos = pos + 30000
        fila = fila + 1
    Loop

    MsgBox "Listo: JSON limpio en columna A (" & fila - 1 & " filas).", vbInformation
End Sub


'------------------ FUNCIONES AUXILIARES ------------------

Private Function LimpiarComentario(s As String) As String
    ' Elimina todo hasta despu√©s de </p> o </span>
    Dim pos As Long
    pos = InStr(1, s, "</p>", vbTextCompare)
    If pos = 0 Then pos = InStr(1, s, "</span>", vbTextCompare)
    If pos > 0 Then s = Mid(s, pos + 4)

    ' Limpieza de entidades b√°sicas
    s = Replace(s, "&nbsp;", " ")
    s = Replace(s, vbCrLf, "")
    s = Replace(s, vbCr, "")
    s = Replace(s, vbLf, "")
    LimpiarComentario = Trim(s)
End Function

Private Function JsonEscape(s As String) As String
    If IsNull(s) Then s = ""
    s = Replace(s, "\", "\\")
    s = Replace(s, """", "\""")
    s = Replace(s, vbCrLf, "\n")
    s = Replace(s, vbCr, "\n")
    s = Replace(s, vbLf, "\n")
    s = Replace(s, vbTab, "\t")
    JsonEscape = s
End Function