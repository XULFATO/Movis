Option Explicit

Private Function NormalizarCodigo(v) As String
    Dim s As String
    s = Trim(CStr(v))
    If Len(s) > 0 And Left$(s, 1) = "'" Then s = Mid$(s, 2)
    s = Replace(s, " ", "")
    ' Si es numérico, quitar ceros iniciales
    If IsNumeric(s) Then
        Do While Len(s) > 1 And Left$(s, 1) = "0"
            s = Mid$(s, 2)
        Loop
    End If
    NormalizarCodigo = s
End Function

Sub Comparar_Mapeo_LRVTOT()
    Dim wsMap As Worksheet, wsRes As Worksheet, wsL As Worksheet
    Dim ultFila As Long, filaR As Long, i As Long
    Dim codMap As String, valF, codL As String, valN
    Dim hojaHit As String, enc As Range, encontrado As Boolean
    Dim dict As Object, cel As Range, rngA As Range
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    ' Hoja Contabilidad_mapeo
    Set wsMap = ThisWorkbook.Sheets("Contabilidad_mapeo")
    
    ' Crear/limpiar hoja Resultados
    On Error Resume Next
    ThisWorkbook.Sheets("Resultados").Delete
    On Error GoTo 0
    Set wsRes = ThisWorkbook.Sheets.Add
    wsRes.Name = "Resultados"
    
    wsRes.Range("A1:E1").Value = Array("Código Contabilidad", "Código LRVTOT", "Valor F", "Valor N", "Resultado")
    wsRes.Rows(1).Font.Bold = True
    filaR = 2
    
    ' Crear diccionario con todos los códigos de LRVTOT*
    Set dict = CreateObject("Scripting.Dictionary")
    For Each wsL In ThisWorkbook.Worksheets
        If wsL.Name Like "LRVTOT*" Or wsL.Name Like "LRUBTOT*" Then
            Set rngA = wsL.Range("A1", wsL.Cells(wsL.Rows.Count, "A").End(xlUp))
            For Each cel In rngA
                If Not IsEmpty(cel.Value) Then
                    codL = NormalizarCodigo(cel.Value)
                    If Not dict.Exists(codL) Then
                        dict(codL) = Array(wsL.Name, cel.Row, wsL.Cells(cel.Row, "N").Value)
                    End If
                End If
            Next cel
        End If
    Next wsL
    
    ' Recorrer Contabilidad_mapeo
    ultFila = wsMap.Cells(wsMap.Rows.Count, "D").End(xlUp).Row
    For i = 3 To ultFila
        If Not wsMap.Cells(i, "D").MergeCells Then
            codMap = NormalizarCodigo(wsMap.Cells(i, "D").Value)
            If codMap <> "" Then
                valF = wsMap.Cells(i, "F").Value
                encontrado = dict.Exists(codMap)
                
                wsRes.Cells(filaR, "A").Value = wsMap.Cells(i, "D").Value
                
                If encontrado Then
                    wsRes.Cells(filaR, "B").Value = codMap
                    wsRes.Cells(filaR, "C").Value = valF
                    wsRes.Cells(filaR, "D").Value = dict(codMap)(2)
                    
                    valN = dict(codMap)(2)
                    If IsNumeric(valF) And IsNumeric(valN) Then
                        If CDbl(valF) = CDbl(valN) Then
                            wsRes.Cells(filaR, "E").Value = "Igual"
                            wsRes.Rows(filaR).Interior.Color = RGB(198, 239, 206)
                        Else
                            wsRes.Cells(filaR, "E").Value = "Diferente"
                            wsRes.Rows(filaR).Interior.Color = RGB(255, 199, 206)
                        End If
                    Else
                        wsRes.Cells(filaR, "E").Value = "Texto/No numérico"
                        wsRes.Rows(filaR).Interior.Color = RGB(255, 235, 156)
                    End If
                Else
                    wsRes.Cells(filaR, "B").Value = ""
                    wsRes.Cells(filaR, "C").Value = valF
                    wsRes.Cells(filaR, "E").Value = "No encontrado"
                    wsRes.Rows(filaR).Interior.Color = RGB(255, 235, 156)
                End If
                
                filaR = filaR + 1
            End If
        End If
    Next i
    
    wsRes.Columns("A:E").AutoFit
    MsgBox "Comparación terminada. Revisa la hoja 'Resultados'.", vbInformation
    
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
End Sub