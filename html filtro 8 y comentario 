Option Explicit

' === FUNCIÓN AUXILIAR PARA NORMALIZAR CÓDIGOS =====================================
' Esta función limpia los códigos que vienen de las celdas (columna D):
' - Quita espacios.
' - Elimina apóstrofes iniciales (cuando Excel guarda como texto, ej. '0930).
' - Quita ceros iniciales solo si el valor es numérico (0930 → 930).
' - Devuelve siempre texto limpio, listo para comparar.
Private Function NormalizarCodigo(v) As String
    Dim s As String
    s = Trim(CStr(v))
    
    ' Quitar el apóstrofe inicial si existe
    If Len(s) > 0 And Left$(s, 1) = "'" Then s = Mid$(s, 2)
    
    ' Eliminar espacios en blanco intermedios
    s = Replace(s, " ", "")
    
    ' Si todo son números, quitar ceros iniciales
    If IsNumeric(s) Then
        Do While Len(s) > 1 And Left$(s, 1) = "0"
            s = Mid$(s, 2)
        Loop
    End If
    
    NormalizarCodigo = s
End Function

' === MACRO PRINCIPAL ==============================================================
Sub Comparar_Mapeo_LRVTOT_Final_v4()
    ' Declaración de variables principales
    Dim wsMap As Worksheet           ' Hoja de origen: Contabilidad_mapeo
    Dim wsRes As Worksheet           ' Hoja destino: Resultados
    Dim wsL As Worksheet             ' Cada hoja LRVTOT / LRUBTOT
    Dim ultFila As Long              ' Última fila con datos en la hoja origen
    Dim filaR As Long                ' Fila de salida en Resultados
    Dim i As Long                    ' Contador de filas
    Dim codMap As String             ' Código de Contabilidad_mapeo (columna D)
    Dim valE, valF, valQ             ' Valores de columnas E, F (origen) y Q (destino)
    Dim codL As String               ' Código de LRVTOT/LRUBTOT (columna A)
    Dim dict As Object               ' Diccionario para buscar rápido los códigos
    Dim cel As Range, rngA As Range  ' Rangos de búsqueda
    Dim startRow As Long, buscarHasta As Long
    Dim bloque As Range, txtBloque As String

    ' === MEJORAS DE RENDIMIENTO ===
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    ' === 1. Definir hoja de origen (donde están los códigos de contabilidad) ===
    Set wsMap = ThisWorkbook.Sheets("Contabilidad_mapeo")
    
    ' === 2. Detectar desde qué fila empezar (después de "Conceptos Fijos") ===
    ' Recorre las celdas combinadas de la columna D hasta encontrar
    ' una que contenga el texto "CONCEPTOS FIJOS" (aunque tenga más texto).
    buscarHasta = wsMap.Cells(wsMap.Rows.Count, "D").End(xlUp).Row
    startRow = 0
    
    For Each cel In wsMap.Range("D1:D" & buscarHasta)
        If cel.MergeCells Then
            Set bloque = cel.MergeArea
            txtBloque = UCase(Trim(bloque.Cells(1, 1).Value))
            
            ' Si contiene "CONCEPTOS FIJOS", empezaremos justo después del bloque
            If InStr(txtBloque, "CONCEPTOS FIJOS") > 0 Then
                startRow = bloque.Row + bloque.Rows.Count
                Exit For
            End If
            
            ' Saltar al final del bloque combinado para evitar repetir
            Set cel = bloque.Cells(bloque.Rows.Count, 1)
        End If
    Next cel
    
    ' Si no se encontró el texto, salir con aviso
    If startRow = 0 Then
        MsgBox "No se encontró ninguna celda combinada que contenga 'Conceptos Fijos' en la columna D.", vbExclamation
        GoTo Salir
    End If

    ' === 3. Crear la hoja de resultados (si existe, se borra) ===
    On Error Resume Next
    ThisWorkbook.Sheets("Resultados").Delete
    On Error GoTo 0
    Set wsRes = ThisWorkbook.Sheets.Add
    wsRes.Name = "Resultados"
    
    ' Encabezados de la hoja Resultados
    wsRes.Range("A1:F1").Value = Array("Código (D)", _
                                       "Código LRVTOT", _
                                       "Valor E (Contabilidad)", _
                                       "Valor F (Contabilidad)", _
                                       "Valor Q (LRVTOT)", _
                                       "Resultado")
    wsRes.Rows(1).Font.Bold = True
    filaR = 2
    
    ' === 4. Construir un diccionario con todos los códigos de LRVTOT/LRUBTOT ===
    ' Este diccionario tendrá como "clave" el código (columna A)
    ' y como "valor" el contenido de la columna Q (la que comparamos ahora).
    Set dict = CreateObject("Scripting.Dictionary")
    
    For Each wsL In ThisWorkbook.Worksheets
        ' Solo procesar hojas cuyo nombre empiece por LRVTOT o LRUBTOT
        If wsL.Name Like "LRVTOT*" Or wsL.Name Like "LRUBTOT*" Then
            ' Definir el rango ocupado de la columna A (códigos)
            Set rngA = wsL.Range("A1", wsL.Cells(wsL.Rows.Count, "A").End(xlUp))
            
            ' Recorrer todos los códigos de esa hoja
            For Each cel In rngA
                If Not IsEmpty(cel.Value) Then
                    codL = NormalizarCodigo(cel.Value)
                    ' Evitar duplicados: solo guardamos el primero encontrado
                    If Not dict.Exists(codL) Then
                        ' Guardamos el valor de la columna Q (misma fila)
                        dict(codL) = wsL.Cells(cel.Row, "Q").Value
                    End If
                End If
            Next cel
        End If
    Next wsL
    
    ' === 5. Recorrer la hoja de Contabilidad_mapeo desde la fila detectada ===
    ultFila = wsMap.Cells(wsMap.Rows.Count, "D").End(xlUp).Row
    
    For i = startRow To ultFila
        
        ' Saltar celdas combinadas (bloques de título)
        If Not wsMap.Cells(i, "D").MergeCells Then
            
            ' Solo procesar si la columna F (Contabilidad) está informada
            If Len(Trim(CStr(wsMap.Cells(i, "F").Value))) > 0 Then
                
                ' Normalizar el código (D)
                codMap = NormalizarCodigo(wsMap.Cells(i, "D").Value)
                
                ' Saltar filas vacías o sin código
                If codMap <> "" Then
                    
                    ' Capturar los valores E (texto o descripción) y F (importe contable)
                    valE = wsMap.Cells(i, "E").Value
                    valF = wsMap.Cells(i, "F").Value
                    
                    ' Escribir el código original en la hoja de resultados
                    wsRes.Cells(filaR, "A").Value = wsMap.Cells(i, "D").Value
                    
                    ' === COMPARACIÓN ===
                    If dict.Exists(codMap) Then
                        ' Código encontrado en LRVTOT → sacar su valor Q
                        valQ = dict(codMap)
                        
                        ' Rellenar las columnas correspondientes
                        wsRes.Cells(filaR, "B").Value = codMap
                        wsRes.Cells(filaR, "C").Value = valE
                        wsRes.Cells(filaR, "D").Value = valF
                        wsRes.Cells(filaR, "E").Value = valQ
                        
                        ' Comparar valores numéricos (F vs Q)
                        If IsNumeric(valF) And IsNumeric(valQ) Then
                            If CDbl(valF) = CDbl(valQ) Then
                                wsRes.Cells(filaR, "F").Value = "Igual"
                                wsRes.Rows(filaR).Interior.Color = RGB(198, 239, 206) ' Verde
                            Else
                                wsRes.Cells(filaR, "F").Value = "Diferente"
                                wsRes.Rows(filaR).Interior.Color = RGB(255, 199, 206) ' Rojo
                            End If
                        Else
                            ' Si no son numéricos, indicamos que no se pueden comparar
                            wsRes.Cells(filaR, "F").Value = "Texto / No numérico"
                            wsRes.Rows(filaR).Interior.Color = RGB(255, 235, 156) ' Amarillo
                        End If
                        
                    Else
                        ' === Caso: código no encontrado en LRVTOT ===
                        wsRes.Cells(filaR, "B").Value = ""
                        wsRes.Cells(filaR, "C").Value = valE
                        wsRes.Cells(filaR, "D").Value = valF
                        wsRes.Cells(filaR, "E").Value = ""
                        wsRes.Cells(filaR, "F").Value = "No encontrado"
                        wsRes.Rows(filaR).Interior.Color = RGB(255, 235, 156) ' Amarillo
                    End If
                    
                    ' Avanzar una fila en la hoja de resultados
                    filaR = filaR + 1
                End If
            End If
        End If
    Next i

    ' === 6. Formato final ===
    wsRes.Columns("A:F").AutoFit
    MsgBox "Comparación terminada. F (Contabilidad) vs Q (LRVTOT).", vbInformation

' === FIN DEL PROCESO ===
Salir:
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
End Sub