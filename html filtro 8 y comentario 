Option Explicit

' ======================================================================
'  FUNCIONES AUXILIARES
' ======================================================================

' Limpia y normaliza códigos de columna D.
Private Function NormalizarCodigo(v As Variant) As String
    Dim s As String
    s = Trim(CStr(v))
    If Len(s) > 0 And Left$(s, 1) = "'" Then s = Mid$(s, 2)
    s = Replace(s, " ", "")
    If IsNumeric(s) Then
        Do While Len(s) > 1 And Left$(s, 1) = "0"
            s = Mid$(s, 2)
        Loop
    End If
    NormalizarCodigo = s
End Function

' Determina si F está informada con número válido (sin "-", ".", vacío, texto).
Private Function EsFValida(v As Variant) As Boolean
    Dim s As String
    s = Trim(CStr(v))
    If s = "" Or s = "-" Or s = "." Then Exit Function
    If Left$(s, 1) = "'" Then s = Mid$(s, 2)
    EsFValida = IsNumeric(s)
End Function

' Devuelve el título del bloque al que pertenece la fila.
' SEGURA: nunca entra en bucle infinito.
Private Function ObtenerTituloBloque(ws As Worksheet, fila As Long) As String
    Dim cel As Range
    Set cel = ws.Cells(fila, "D")

    ' Si la celda pertenece a una zona combinada, devolvemos ese título
    If cel.MergeCells Then
        ObtenerTituloBloque = cel.MergeArea.Cells(1, 1).Value
    Else
        ' Buscamos hacia arriba la última celda combinada
        Do While fila > 1
            fila = fila - 1
            If ws.Cells(fila, "D").MergeCells Then
                ObtenerTituloBloque = ws.Cells(fila, "D").MergeArea.Cells(1, 1).Value
                Exit Do
            End If
        Loop
        ' Si no encuentra ninguna celda combinada, devuelve vacío
        If fila = 1 Then ObtenerTituloBloque = ""
    End If
End Function

' ======================================================================
'  MACRO PRINCIPAL (versión segura)
' ======================================================================

Sub Comparar_Mapeo_LRVTOT_Final_v6()
    Dim wsMap As Worksheet, wsRes As Worksheet, wsL As Worksheet
    Dim dict As Object
    Dim rngA As Range, cel As Range
    Dim ultFila As Long, filaR As Long, i As Long
    Dim codMap As String, valE, valF, valQ, codL As String
    Dim tituloBloque As String

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    Set wsMap = ThisWorkbook.Sheets("Contabilidad_mapeo")

    ' Crear hoja de resultados
    On Error Resume Next
    ThisWorkbook.Sheets("Resultados").Delete
    On Error GoTo 0
    Set wsRes = ThisWorkbook.Sheets.Add
    wsRes.Name = "Resultados"

    ' Cabecera
    wsRes.Range("A1:G1").Value = Array( _
        "Título del bloque (celda combinada D)", _
        "Código (D) Contabilidad", _
        "Código LRVTOT/LRUBTOT", _
        "Valor E (Contabilidad)", _
        "Valor F (Contabilidad)", _
        "Valor Q (LRVTOT/LRUBTOT)", _
        "Resultado (F vs Q)" _
    )
    wsRes.Rows(1).Font.Bold = True
    filaR = 2

    ' Construir índice de LRVTOT/LRUBTOT
    Set dict = CreateObject("Scripting.Dictionary")
    For Each wsL In ThisWorkbook.Worksheets
        If wsL.Name Like "LRVTOT*" Or wsL.Name Like "LRUBTOT*" Then
            Set rngA = wsL.Range("A1", wsL.Cells(wsL.Rows.Count, "A").End(xlUp))
            For Each cel In rngA
                If Len(Trim(cel.Value)) > 0 Then
                    codL = NormalizarCodigo(cel.Value)
                    If Not dict.Exists(codL) Then
                        dict.Add codL, wsL.Cells(cel.Row, "Q").Value
                    End If
                End If
            Next cel
        End If
    Next wsL

    ' Recorrer todas las filas de D
    ultFila = wsMap.Cells(wsMap.Rows.Count, "D").End(xlUp).Row
    For i = 3 To ultFila
        If Not wsMap.Cells(i, "D").MergeCells Then
            ' Filtramos solo filas válidas (F numérica)
            If EsFValida(wsMap.Cells(i, "F").Value) Then
                codMap = NormalizarCodigo(wsMap.Cells(i, "D").Value)
                If codMap <> "" Then
                    valE = wsMap.Cells(i, "E").Value
                    valF = wsMap.Cells(i, "F").Value
                    tituloBloque = ObtenerTituloBloque(wsMap, i)

                    ' Escribir en Resultados
                    wsRes.Cells(filaR, "A").Value = tituloBloque
                    wsRes.Cells(filaR, "B").Value = wsMap.Cells(i, "D").Value

                    If dict.Exists(codMap) Then
                        valQ = dict(codMap)
                        wsRes.Cells(filaR, "C").Value = codMap
                        wsRes.Cells(filaR, "D").Value = valE
                        wsRes.Cells(filaR, "E").Value = valF
                        wsRes.Cells(filaR, "F").Value = valQ

                        If IsNumeric(valF) And IsNumeric(valQ) Then
                            If CDbl(valF) = CDbl(valQ) Then
                                wsRes.Cells(filaR, "G").Value = "Igual"
                                wsRes.Rows(filaR).Interior.Color = RGB(198, 239, 206)
                            Else
                                wsRes.Cells(filaR, "G").Value = "Diferente"
                                wsRes.Rows(filaR).Interior.Color = RGB(255, 199, 206)
                            End If
                        Else
                            wsRes.Cells(filaR, "G").Value = "Texto / No numérico"
                            wsRes.Rows(filaR).Interior.Color = RGB(255, 235, 156)
                        End If
                    Else
                        wsRes.Cells(filaR, "C").Value = ""
                        wsRes.Cells(filaR, "D").Value = valE
                        wsRes.Cells(filaR, "E").Value = valF
                        wsRes.Cells(filaR, "F").Value = ""
                        wsRes.Cells(filaR, "G").Value = "No encontrado"
                        wsRes.Rows(filaR).Interior.Color = RGB(255, 235, 156)
                    End If
                    filaR = filaR + 1
                End If
            End If
        End If
    Next i

    wsRes.Columns("A:G").AutoFit
    MsgBox "✅ Comparación completada sin bucles. Bloques detectados correctamente.", vbInformation

    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
End Sub