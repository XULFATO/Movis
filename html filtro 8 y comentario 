Option Explicit

Sub Comparar_Col1_Col2_DesdeFila2_Ordenado()
    Dim sh As Worksheet
    Dim ultFila1 As Long, ultFila2 As Long, ultFila As Long
    Dim i As Long
    Dim dictCol1 As Object, dictCol2 As Object
    Dim clave As Variant
    Dim filaSolo1 As Long, filaSolo2 As Long, filaAmbas As Long
    Dim lastSolo1 As Long, lastSolo2 As Long, lastAmbas As Long
    
    Set sh = ActiveSheet
    
    ' Última fila usada en cada columna (busca desde abajo)
    ultFila1 = sh.Cells(sh.Rows.Count, "A").End(xlUp).Row
    ultFila2 = sh.Cells(sh.Rows.Count, "B").End(xlUp).Row
    ultFila = Application.WorksheetFunction.Max(ultFila1, ultFila2)
    
    ' Diccionarios
    Set dictCol1 = CreateObject("Scripting.Dictionary")
    Set dictCol2 = CreateObject("Scripting.Dictionary")
    
    ' Rellenar diccionario Columna 1 (A), desde fila 2
    For i = 2 To ultFila1
        If Trim(sh.Cells(i, "A").Value) <> "" Then
            If Not dictCol1.Exists(Trim(sh.Cells(i, "A").Value)) Then
                dictCol1.Add Trim(sh.Cells(i, "A").Value), True
            End If
        End If
    Next i
    
    ' Rellenar diccionario Columna 2 (B), desde fila 2
    For i = 2 To ultFila2
        If Trim(sh.Cells(i, "B").Value) <> "" Then
            If Not dictCol2.Exists(Trim(sh.Cells(i, "B").Value)) Then
                dictCol2.Add Trim(sh.Cells(i, "B").Value), True
            End If
        End If
    Next i
    
    ' Limpiar solo resultados, sin tocar fila 1
    sh.Range("C2:E" & sh.Rows.Count).ClearContents
    
    ' Filas de salida (empiezan en 2)
    filaSolo1 = 2
    filaSolo2 = 2
    filaAmbas = 2
    
    ' Recorremos valores de la Columna 1
    For Each clave In dictCol1.Keys
        If dictCol2.Exists(clave) Then
            ' Está en las dos: columna 5 (E)
            sh.Cells(filaAmbas, "E").Value = clave
            filaAmbas = filaAmbas + 1
        Else
            ' Solo en columna 1: columna 3 (C)
            sh.Cells(filaSolo1, "C").Value = clave
            filaSolo1 = filaSolo1 + 1
        End If
    Next clave
    
    ' Recorremos valores de la Columna 2
    For Each clave In dictCol2.Keys
        If Not dictCol1.Exists(clave) Then
            ' Solo en columna 2: columna 4 (D)
            sh.Cells(filaSolo2, "D").Value = clave
            filaSolo2 = filaSolo2 + 1
        End If
    Next clave
    
    ' Últimas filas realmente usadas en cada bloque
    lastSolo1 = filaSolo1 - 1
    lastSolo2 = filaSolo2 - 1
    lastAmbas = filaAmbas - 1
    
    ' Ordenar cada bloque si tiene datos
    With sh
        If lastSolo1 >= 2 Then
            .Range("C2:C" & lastSolo1).Sort Key1:=.Range("C2"), Order1:=xlAscending, Header:=xlNo
        End If
        If lastSolo2 >= 2 Then
            .Range("D2:D" & lastSolo2).Sort Key1:=.Range("D2"), Order1:=xlAscending, Header:=xlNo
        End If
        If lastAmbas >= 2 Then
            .Range("E2:E" & lastAmbas).Sort Key1:=.Range("E2"), Order1:=xlAscending, Header:=xlNo
        End If
        
        .Columns("A:E").AutoFit
    End With
    
    MsgBox "Comparación completada. Revisa columnas C (solo 1), D (solo 2) y E (ambas), desde fila 2.", vbInformation
End Sub