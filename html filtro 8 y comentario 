Option Explicit

Sub Comparar_Contabilidad_LRVTOT()
    Dim wsMapeo As Worksheet, wsDest As Worksheet, wsRes As Worksheet
    Dim ultFila As Long, i As Long, filaRes As Long
    Dim valorD As String, valorF As Variant, valorG As Variant
    Dim hojaLRV As Worksheet, encontrada As Boolean
    Dim cel As Range, rngBuscar As Range, celBuscada As Range
    Dim valorN As Variant, diferencia As Variant
    Dim hojaNombre As String

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    '=== Hoja origen ===
    Set wsMapeo = ThisWorkbook.Sheets("Contabilidad Mapeo")
    
    '=== Crear/limpiar hoja de resultados ===
    On Error Resume Next
    ThisWorkbook.Sheets("Resultados").Delete
    On Error GoTo 0
    Set wsRes = ThisWorkbook.Sheets.Add
    wsRes.Name = "Resultados"
    
    ' Cabecera
    wsRes.Range("A1:E1").Value = Array("Código (D)", "Valor F (Contab)", "Valor N (LRVTOT)", "Diferencia", "Estado")
    wsRes.Rows(1).Font.Bold = True
    filaRes = 2
    
    ' Última fila con datos en columna D
    ultFila = wsMapeo.Cells(wsMapeo.Rows.Count, "D").End(xlUp).Row
    
    ' Recorrer filas desde D3 hasta última
    For i = 3 To ultFila
        ' Saltar celdas combinadas
        If wsMapeo.Cells(i, "D").MergeCells = False Then
            valorD = Trim(wsMapeo.Cells(i, "D").Value)
            If Len(valorD) > 0 Then
                valorF = wsMapeo.Cells(i, "F").Value
                valorG = wsMapeo.Cells(i, "G").Value
                
                encontrada = False
                valorN = ""
                
                ' Buscar en hojas que empiecen por LRVTOT
                For Each hojaLRV In ThisWorkbook.Worksheets
                    If hojaLRV.Name Like "LRVTOT*" Then
                        Set rngBuscar = hojaLRV.Columns("A")
                        Set celBuscada = rngBuscar.Find(What:=valorD, LookIn:=xlValues, LookAt:=xlWhole)
                        If Not celBuscada Is Nothing Then
                            valorN = hojaLRV.Cells(celBuscada.Row, "N").Value
                            encontrada = True
                            Exit For
                        End If
                    End If
                Next hojaLRV
                
                ' Resultado
                wsRes.Cells(filaRes, "A").Value = valorD
                wsRes.Cells(filaRes, "B").Value = valorF
                wsRes.Cells(filaRes, "C").Value = valorN
                
                If encontrada Then
                    If IsNumeric(valorF) And IsNumeric(valorN) Then
                        diferencia = CDbl(valorF) - CDbl(valorN)
                        wsRes.Cells(filaRes, "D").Value = diferencia
                        If Abs(diferencia) < 0.0001 Then
                            wsRes.Cells(filaRes, "E").Value = "Igual"
                            wsRes.Rows(filaRes).Interior.Color = RGB(198, 239, 206) ' Verde
                        Else
                            wsRes.Cells(filaRes, "E").Value = "Diferente"
                            wsRes.Rows(filaRes).Interior.Color = RGB(255, 199, 206) ' Rojo
                        End If
                    Else
                        wsRes.Cells(filaRes, "E").Value = "Datos no numéricos"
                        wsRes.Rows(filaRes).Interior.Color = RGB(255, 235, 156) ' Amarillo
                    End If
                Else
                    wsRes.Cells(filaRes, "E").Value = "No encontrado"
                    wsRes.Rows(filaRes).Interior.Color = RGB(255, 235, 156) ' Amarillo
                End If
                
                filaRes = filaRes + 1
            End If
        End If
    Next i
    
    ' Formato
    wsRes.Columns("A:E").AutoFit
    wsRes.Range("D2:D" & filaRes - 1).NumberFormat = "#,##0.00"
    
    Application.ScreenUpdating = True
    MsgBox "Comparación completada. Resultados creados en la hoja 'Resultados'.", vbInformation
End Sub