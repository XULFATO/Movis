Sub ExtraerComentariosJson()
    Dim fso As Object, folder As Object, file As Object
    Dim txt As String, regex As Object, match As Object
    Dim p As Long, comment As String
    Dim jsonText As String, firstItem As Boolean
    
    ' Carpeta donde están los .htm
    Const rutaCarpeta As String = "C:\Users\TuUsuario\CarpetaHTML" ' ⚠️ cambia esto

    Set fso = CreateObject("Scripting.FileSystemObject")
    Set folder = fso.GetFolder(rutaCarpeta)
    Set regex = CreateObject("VBScript.RegExp")
    regex.IgnoreCase = True
    regex.Global = False
    regex.Pattern = "comentarios\s*a\s*las\s*tablas\s*del\s*vr"

    jsonText = "["
    firstItem = True

    For Each file In folder.Files
        If LCase(fso.GetExtensionName(file.Name)) = "htm" Then
            txt = fso.OpenTextFile(file.Path, 1, False).ReadAll
            txt = Replace(txt, "<", " <")
            txt = Replace(txt, ">", "> ")
            
            If regex.Test(txt) Then
                Set match = regex.Execute(txt)(0)
                p = match.FirstIndex + 1
                comment = Mid(txt, p)
                
                If Not firstItem Then jsonText = jsonText & "," & vbCrLf
                jsonText = jsonText & _
                    "{""file"":""" & JsonEscape(file.Name) & """,""comments"":""" & JsonEscape(comment) & """}"
                firstItem = False
            End If
        End If
    Next

    jsonText = jsonText & "]"

    ' Escribir el JSON en la celda A1
    With ThisWorkbook.Sheets(1)
        .Cells.Clear
        .Range("A1").Value = jsonText
        .Columns("A").EntireColumn.AutoFit
    End With

    MsgBox "JSON generado en la celda A1", vbInformation
End Sub


Private Function JsonEscape(s As String) As String
    If IsNull(s) Then s = ""
    s = Replace(s, "\", "\\")
    s = Replace(s, """", "\""")
    s = Replace(s, vbCrLf, "\n")
    s = Replace(s, vbCr, "\n")
    s = Replace(s, vbLf, "\n")
    s = Replace(s, vbTab, "\t")
    JsonEscape = s
End Function