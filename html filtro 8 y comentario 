Sub ExtraerComentariosJson()
    Dim fso, folder, file, txt, regex, match, p, comment
    Dim items, jsonText, salida, firstItem

    Set fso = CreateObject("Scripting.FileSystemObject")
    Set folder = fso.GetFolder(".")

    Set regex = CreateObject("VBScript.RegExp")
    regex.IgnoreCase = True
    regex.Global = False
    regex.Pattern = "comentarios\s*a\s*las\s*tablas\s*del\s*vr"

    jsonText = "["
    firstItem = True

    For Each file In folder.Files
        If LCase(fso.GetExtensionName(file.Name)) = "htm" Then
            txt = fso.OpenTextFile(file.Path, 1, False).ReadAll

            ' Normalización para evitar que las etiquetas rompan el texto
            txt = Replace(txt, "<", " <")
            txt = Replace(txt, ">", "> ")

            If regex.Test(txt) Then
                Set match = regex.Execute(txt)(0)
                p = match.FirstIndex + 1
                comment = Mid(txt, p)

                ' Escapar comillas y saltos
                comment = JsonEscape(comment)
                Dim jsonItem
                jsonItem = "{""file"":""" & JsonEscape(file.Name) & """,""comments"":""" & comment & """}"

                If Not firstItem Then
                    jsonText = jsonText & "," & vbCrLf
                End If
                jsonText = jsonText & jsonItem
                firstItem = False
            End If
        End If
    Next

    jsonText = jsonText & "]"

    ' Guardar con FSO clásico (sin ADO)
    Set salida = fso.CreateTextFile("comentarios.json", True)
    salida.Write jsonText
    salida.Close

    MsgBox "Listo. Se generó comentarios.json en esta carpeta.", vbInformation
End Sub

'------------------ Helpers ------------------
Function JsonEscape(s)
    If IsNull(s) Then s = ""
    s = Replace(s, "\", "\\")
    s = Replace(s, """", "\""")
    s = Replace(s, vbCrLf, "\n")
    s = Replace(s, vbCr, "\n")
    s = Replace(s, vbLf, "\n")
    s = Replace(s, vbTab, "\t")
    JsonEscape = s
End Function

' Ejecutar
Call ExtraerComentariosJson