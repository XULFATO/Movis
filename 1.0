Option Explicit

Sub OfuscarYGenerarBas()
    Dim fDialog As FileDialog
    Dim origen As String
    Dim destino As String
    Dim wb As Workbook
    Dim vbComp As Object
    Dim codigo As String
    Dim filePath As String
    Dim basFileName As String
    Dim respuesta As VbMsgBoxResult
    
    ' Seleccionar archivo de origen
    Set fDialog = Application.FileDialog(msoFileDialogOpen)
    fDialog.Title = "Seleccionar archivo Excel (.xlsm)"
    fDialog.Filters.Clear
    fDialog.Filters.Add "Archivos de Excel", "*.xlsm"
    
    If fDialog.Show = -1 Then
        origen = fDialog.SelectedItems(1)
        
        ' Abrir el archivo de origen
        Set wb = Workbooks.Open(origen, ReadOnly:=True, Password:="")
        
        ' Preguntar al usuario por la ruta de destino del archivo .bas
        filePath = Application.InputBox("Escribe la ruta completa (incluyendo el nombre) para guardar el archivo .bas", "Guardar archivo .bas", Type:=2)
        
        ' Comprobar si el usuario ha cancelado o no ha ingresado un nombre
        If filePath = "" Then
            MsgBox "Operación cancelada.", vbExclamation
            Exit Sub
        End If
        
        ' Procesar cada componente VBA
        For Each vbComp In wb.VBProject.VBComponents
            If vbComp.Type = vbext_ct_StdModule Or vbComp.Type = vbext_ct_ClassModule Or vbComp.Type = vbext_ct_MSForm Or vbComp.Type = vbext_ct_ActiveXDesigner Then
                codigo = vbComp.CodeModule.Lines(1, vbComp.CodeModule.CountOfLines)
                codigo = OfuscarCodigo(codigo)
                
                ' Crear archivo .bas
                basFileName = filePath & "\" & vbComp.Name & ".bas"
                Call CrearArchivoBas(basFileName, codigo)
            End If
        Next vbComp
        
        ' Cerrar el archivo de origen
        wb.Close SaveChanges:=False
        MsgBox "Ofuscación completa. Archivos .bas generados.", vbInformation
    End If
End Sub

Function OfuscarCodigo(codigo As String) As String
    Dim lineas() As String
    Dim i As Long
    Dim linea As String
    Dim nuevoCodigo As String
    Dim variableCounter As Long
    Dim renombrados As Collection
    
    ' Inicializar colección para renombrar variables
    Set renombrados = New Collection
    variableCounter = 1
    
    ' Separar el código en líneas
    lineas = Split(codigo, vbNewLine)
    
    ' Procesar cada línea
    For i = LBound(lineas) To UBound(lineas)
        linea = lineas(i)
        
        ' Eliminar comentarios
        If InStr(linea, "'") > 0 Then
            linea = Left(linea, InStr(linea, "'") - 1)
        End If
        
        ' Renombrar Private Subs y Functions
        If InStr(linea, "Private Sub ") > 0 Then
            linea = Replace(linea, "Private Sub ", "Private Sub P_" & variableCounter & "_")
            variableCounter = variableCounter + 1
        ElseIf InStr(linea, "Private Function ") > 0 Then
            linea = Replace(linea, "Private Function ", "Private Function F_" & variableCounter & "_")
            variableCounter = variableCounter + 1
        End If
        
        ' Renombrado de variables locales (simplificado)
        If InStr(linea, "Dim ") > 0 Then
            Do While InStr(linea, "Dim ") > 0
                Dim variable As String
                variable = Mid(linea, InStr(linea, "Dim ") + 4, InStr(InStr(linea, "Dim "), " As ") - InStr(linea, "Dim ") - 4)
                If Not VariableYaRenombrada(variable, renombrados) Then
                    linea = Replace(linea, variable, "v_" & variableCounter)
                    renombrados.Add variable
                    variableCounter = variableCounter + 1
                End If
            Loop
        End If
        
        ' Añadir línea procesada al nuevo código
        If Trim(linea) <> "" Then
            nuevoCodigo = nuevoCodigo & linea & vbNewLine
        End If
    Next i
    
    OfuscarCodigo = nuevoCodigo
End Function

Sub CrearArchivoBas(path As String, codigo As String)
    Dim fileNum As Integer
    fileNum = FreeFile
    Open path For Output As #fileNum
    Print #fileNum, codigo
    Close #fileNum
End Sub

Function VariableYaRenombrada(variable As String, ByRef renombrados As Collection) As Boolean
    Dim i As Long
    VariableYaRenombrada = False
    On Error Resume Next
    For i = 1 To renombrados.Count
        If renombrados(i) = variable Then
            VariableYaRenombrada = True
            Exit Function
        End If
    Next i
    On Error GoTo 0
End Function
