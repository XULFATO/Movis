tion
Private Function RestoreLineSmart(ByVal ln As String, ByVal key As Long) As String
    Dim codePart As String, commentPart As String
    Dim pComment As Long

    ' --- separar comentario inline ---
    pComment = InStr(ln, "'")
    If pComment > 0 Then
        codePart = Left$(ln, pComment - 1)
        commentPart = Mid$(ln, pComment)
    Else
        codePart = ln
        commentPart = ""
    End If

    ' --- restaurar comentarios ofuscados ---
    Dim p As Long
    p = InStr(codePart, "'_")
    If p > 0 Then
        Dim colonPos As Long
        colonPos = InStr(p, codePart, ":")
        If colonPos > 0 Then
            Dim hexStr As String
            hexStr = Mid$(codePart, colonPos + 1)
            RestoreLineSmart = Left$(codePart, p - 1) & "'" & FromHex4Fast(hexStr, key) & commentPart
            Exit Function
        End If
    End If

    ' --- restaurar dDecode ---
    Dim result As String
    result = codePart

    Do While InStr(result, "dDecode(""") > 0
        Dim p1 As Long, p2 As Long, pEnd As Long
        Dim hex As String, decoded As String

        p1 = InStr(result, "dDecode(""")
        p2 = InStr(p1 + 10, result, """")
        pEnd = InStr(p2 + 1, result, ")")

        If p2 = 0 Or pEnd = 0 Then Exit Do

        hex = Mid$(result, p1 + 10, p2 - p1 - 10)
        decoded = FromHex4Fast(hex, key)

        result = Left$(result, p1 - 1) & """" & decoded & """" & Mid$(result, pEnd + 1)
    Loop

    RestoreLineSmart = result & commentPart
End Function
