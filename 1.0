# ==========================================================
# ELIMINAR TODAS LAS HOJAS SALVO "AN√ÅLISIS CONCEPTOS" (con variaciones)
# ==========================================================

# === CONFIGURACI√ìN ===
$carpetaOrigen = "C:\Ruta\A\TusExcels"      # <-- CAMBIA ESTA RUTA
$regexHoja = '(?i)^an[a√°]lisis\s*conceptos?$'   # admite tilde/no tilde y singular/plural
$backupCarpeta = "$carpetaOrigen\_backup"

# === OPCIONAL: Crear copia de seguridad ===
if (-not (Test-Path $backupCarpeta)) {
    Write-Host "Creando carpeta de backup en $backupCarpeta" -ForegroundColor Cyan
    New-Item -ItemType Directory -Path $backupCarpeta | Out-Null
}

# === ARRANQUE DE EXCEL ===
Add-Type -AssemblyName Microsoft.Office.Interop.Excel
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$excel.DisplayAlerts = $false

$archivos = Get-ChildItem -Path $carpetaOrigen -Filter *.xls* -File -Recurse | Where-Object { $_.Name -notmatch '^~\$' }

Write-Host "`nProcesando $($archivos.Count) archivos Excel..." -ForegroundColor Cyan

foreach ($archivo in $archivos) {
    Write-Host "üìÑ $($archivo.Name)" -ForegroundColor Yellow
    try {
        # Copia de seguridad (solo la primera vez o si no existe)
        $destinoBackup = Join-Path $backupCarpeta $archivo.Name
        if (-not (Test-Path $destinoBackup)) {
            Copy-Item $archivo.FullName -Destination $destinoBackup -Force
        }

        $wb = $excel.Workbooks.Open($archivo.FullName, $false, $false)
        $hojas = @($wb.Sheets)
        $hojaPrincipal = $null

        # Buscar la hoja v√°lida
        foreach ($h in $hojas) {
            if ($h.Name -match $regexHoja) {
                $hojaPrincipal = $h
                break
            }
        }

        if ($hojaPrincipal -eq $null) {
            Write-Host "   ‚ö† No se encontr√≥ ninguna hoja 'An√°lisis Conceptos'" -ForegroundColor Red
            $wb.Close($false)
            continue
        }

        # Borrar todas las dem√°s hojas
        foreach ($h in $hojas) {
            if ($h.Name -ne $hojaPrincipal.Name) {
                try {
                    $h.Delete()
                } catch {
                    Write-Host "   ‚ö† No se pudo eliminar hoja '$($h.Name)': $($_.Exception.Message)" -ForegroundColor DarkYellow
                }
            }
        }

        # Guardar cambios
        $wb.Save()
        $wb.Close($false)
        Write-Host "   ‚úÖ Solo se dej√≥ la hoja '$($hojaPrincipal.Name)'" -ForegroundColor Green
    }
    catch {
        Write-Host "   ‚ùå Error en $($archivo.Name): $($_.Exception.Message)" -ForegroundColor Red
        try { $wb.Close($false) } catch {}
    }
}

$excel.Quit()
[System.GC]::Collect(); [System.GC]::WaitForPendingFinalizers()

Write-Host "`nüèÅ Proceso completado. Copias de seguridad en $backupCarpeta" -ForegroundColor Cyan