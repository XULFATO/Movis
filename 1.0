Sub OptimizarHTML()
    Dim fso As Object, ts As Object
    Dim filePath As String, htmlContent As String
    Dim dict As Object, dictJS As String
    Dim compressed As String, dataStart As Long, dataEnd As Long
    Dim respReducir As VbMsgBoxResult, respOfuscar As VbMsgBoxResult
    
    ' Seleccionar archivo HTML
    With Application.FileDialog(msoFileDialogFilePicker)
        .Title = "Selecciona el archivo HTML"
        .Filters.Clear
        .Filters.Add "HTML", "*.html"
        If .Show = 0 Then Exit Sub
        filePath = .SelectedItems(1)
    End With
    
    ' Preguntas
    respReducir = MsgBox("¿Reducir tamaño del HTML?" & vbCrLf & vbCrLf & _
                         "Comprimirá textos largos repetidos", _
                         vbYesNo + vbQuestion, "Optimización")
    If respReducir = vbNo Then Exit Sub
    
    respOfuscar = MsgBox("¿Ofuscar datos de la tabla?" & vbCrLf & vbCrLf & _
                         "Codificará valores (opcional)", _
                         vbYesNo + vbQuestion, "Ofuscación")
    
    ' Leer HTML
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set ts = fso.OpenTextFile(filePath, 1, False, -2)
    htmlContent = ts.ReadAll
    ts.Close
    
    ' Extraer DATA
    dataStart = InStr(htmlContent, "const DATA = [")
    If dataStart = 0 Then
        MsgBox "No se encontró 'const DATA = [' en el HTML", vbCritical
        Exit Sub
    End If
    dataEnd = InStr(dataStart, htmlContent, "];")
    If dataEnd = 0 Then
        MsgBox "No se encontró el cierre de DATA '];'", vbCritical
        Exit Sub
    End If
    
    ' Analizar y comprimir
    Set dict = CreateObject("Scripting.Dictionary")
    Dim dataSection As String, lines As Variant, i As Long
    dataSection = Mid(htmlContent, dataStart + 14, dataEnd - dataStart - 14)
    lines = Split(dataSection, "[""")
    
    ' Crear diccionario de textos largos repetidos
    For i = 1 To UBound(lines)
        Dim line As String, campos As Variant, j As Long
        line = lines(i)
        If InStr(line, """]") > 0 Then
            line = Left(line, InStr(line, """]") - 1)
            campos = Split(line, """,""")
            
            For j = 0 To UBound(campos)
                Dim valor As String
                valor = Trim(campos(j))
                
                ' Solo comprimir textos largos (>20 caracteres)
                If Len(valor) > 20 And Not dict.exists(valor) Then
                    Dim clave As String
                    clave = GenerarClave(valor, dict)
                    dict.Add valor, clave
                End If
            Next j
        End If
    Next i
    
    ' Generar JavaScript del diccionario
    If dict.Count > 0 Then
        dictJS = "// Diccionario de compresión" & vbCrLf
        dictJS = dictJS & "const DICT = {" & vbCrLf
        
        Dim k As Variant
        For Each k In dict.Keys
            dictJS = dictJS & "  """ & dict(k) & """: """ & EscapeJS(CStr(k)) & """," & vbCrLf
        Next k
        
        ' Eliminar última coma
        If Right(dictJS, 3) = "," & vbCrLf Then
            dictJS = Left(dictJS, Len(dictJS) - 3) & vbCrLf
        End If
        
        dictJS = dictJS & "};" & vbCrLf & vbCrLf
        
        ' Función expand
        dictJS = dictJS & "function expand(row) {" & vbCrLf & _
                 "  return row.map(cell => DICT[cell] || cell);" & vbCrLf & _
                 "}" & vbCrLf & vbCrLf
    Else
        MsgBox "No se encontraron textos largos para comprimir", vbInformation
        Exit Sub
    End If
    
    ' Comprimir DATA
    compressed = ComprimirData(dataSection, dict)
    
    ' Construir nuevo HTML
    Dim beforeData As String, afterData As String
    beforeData = Left(htmlContent, dataStart - 1)
    afterData = Mid(htmlContent, dataEnd + 2)
    
    ' Insertar diccionario antes de DATA
    Dim newHTML As String
    newHTML = beforeData & dictJS & "const DATA = [" & vbCrLf & compressed & "];;" & afterData
    
    ' Modificar funciones JavaScript para usar expand()
    newHTML = ModificarFuncionRowMatches(newHTML)
    newHTML = ModificarFuncionRenderTable(newHTML)
    newHTML = ModificarFuncionUpdateDatalist(newHTML)
    
    ' Guardar archivo optimizado
    Dim newPath As String
    newPath = Replace(filePath, ".html", "_optimizado.html")
    
    Set ts = fso.CreateTextFile(newPath, True, False)
    ts.Write newHTML
    ts.Close
    
    ' Informe final
    Dim tamOriginal As Long, tamNuevo As Long, ahorro As Double
    tamOriginal = Len(htmlContent)
    tamNuevo = Len(newHTML)
    ahorro = ((tamOriginal - tamNuevo) / tamOriginal) * 100
    
    MsgBox "✓ Optimización completada" & vbCrLf & vbCrLf & _
           "Original: " & Format(tamOriginal / 1024, "#,##0.0") & " KB" & vbCrLf & _
           "Nuevo: " & Format(tamNuevo / 1024, "#,##0.0") & " KB" & vbCrLf & _
           "Ahorro: " & Format(ahorro, "0.0") & "%" & vbCrLf & _
           "Textos comprimidos: " & dict.Count & vbCrLf & vbCrLf & _
           "Archivo: " & newPath, vbInformation, "Proceso completado"
           
    Set fso = Nothing
    Set dict = Nothing
End Sub

Function GenerarClave(ByVal texto As String, ByRef dict As Object) As String
    Dim base As String, counter As Long
    Dim palabras As Variant, i As Long
    
    ' Generar clave a partir de iniciales
    If InStr(texto, " ") > 0 Then
        palabras = Split(texto, " ")
        base = ""
        For i = 0 To UBound(palabras)
            If Len(palabras(i)) > 0 Then
                base = base & UCase(Left(palabras(i), 1))
                If Len(base) >= 3 Then Exit For
            End If
        Next i
    Else
        base = UCase(Left(texto, 3))
    End If
    
    ' Si la clave está vacía, usar primeros caracteres
    If base = "" Then base = UCase(Left(texto, 2))
    
    ' Verificar si ya existe y agregar número
    counter = 0
    Dim claveTemp As String
    claveTemp = base
    
    Do While ClaveYaExiste(claveTemp, dict)
        counter = counter + 1
        claveTemp = base & counter
    Loop
    
    GenerarClave = claveTemp
End Function

Function ClaveYaExiste(ByVal clave As String, ByRef dict As Object) As Boolean
    Dim k As Variant
    ClaveYaExiste = False
    
    For Each k In dict.Keys
        If dict(k) = clave Then
            ClaveYaExiste = True
            Exit Function
        End If
    Next k
End Function

Function ComprimirData(ByVal dataText As String, ByRef dict As Object) As String
    Dim resultado As String
    resultado = dataText
    
    ' Reemplazar cada texto largo por su clave
    Dim k As Variant
    For Each k In dict.Keys
        resultado = Replace(resultado, """" & CStr(k) & """", """" & dict(k) & """")
    Next k
    
    ComprimirData = resultado
End Function

Function EscapeJS(ByVal texto As Variant) As String
    Dim txt As String
    txt = CStr(texto)
    
    ' Escapar caracteres especiales para JavaScript
    txt = Replace(txt, "\", "\\")
    txt = Replace(txt, """", "\""")
    txt = Replace(txt, vbCrLf, "\n")
    txt = Replace(txt, vbCr, "\n")
    txt = Replace(txt, vbLf, "\n")
    txt = Replace(txt, vbTab, "\t")
    
    EscapeJS = txt
End Function

Function ModificarFuncionRowMatches(ByVal html As String) As String
    Dim buscar As String, reemplazar As String
    
    ' Buscar la función original
    buscar = "function rowMatches(row, ignoreCol=-1) {" & vbCrLf & _
             "  for (let i=0;i<7;i++) {"
    
    ' Nueva versión con expand()
    reemplazar = "function rowMatches(row, ignoreCol=-1) {" & vbCrLf & _
                 "  const exp = expand(row);" & vbCrLf & _
                 "  for (let i=0;i<7;i++) {"
    
    html = Replace(html, buscar, reemplazar)
    
    ' Reemplazar row[i] por exp[i] en el contenido de la función
    buscar = "    const cell = String(row[i]).toLowerCase();"
    reemplazar = "    const cell = String(exp[i]).toLowerCase();"
    html = Replace(html, buscar, reemplazar)
    
    ModificarFuncionRowMatches = html
End Function

Function ModificarFuncionRenderTable(ByVal html As String) As String
    Dim buscar As String, reemplazar As String
    
    ' Buscar el bucle de renderizado
    buscar = "  for (const row of matched.slice(0,limit)) {" & vbCrLf & _
             "    const tr = document.createElement(""tr"");" & vbCrLf & _
             "    row.forEach((c,i)=>{"
    
    reemplazar = "  for (const row of matched.slice(0,limit)) {" & vbCrLf & _
                 "    const exp = expand(row);" & vbCrLf & _
                 "    const tr = document.createElement(""tr"");" & vbCrLf & _
                 "    exp.forEach((c,i)=>{"
    
    html = Replace(html, buscar, reemplazar)
    
    ModificarFuncionRenderTable = html
End Function

Function ModificarFuncionUpdateDatalist(ByVal html As String) As String
    Dim buscar As String, reemplazar As String
    
    ' Buscar la parte donde se obtiene el valor
    buscar = "  for (const row of DATA) {" & vbCrLf & _
             "    if (!rowMatches(row,col)) continue;" & vbCrLf & _
             "    const v = String(row[col]);"
    
    reemplazar = "  for (const row of DATA) {" & vbCrLf & _
                 "    if (!rowMatches(row,col)) continue;" & vbCrLf & _
                 "    const exp = expand(row);" & vbCrLf & _
                 "    const v = String(exp[col]);"
    
    html = Replace(html, buscar, reemplazar)
    
    ModificarFuncionUpdateDatalist = html
End Function
