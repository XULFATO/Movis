Option Explicit

Sub OfuscarCodigoVBA()
    Dim fDialog As FileDialog
    Dim origen As String
    Dim destino As String
    Dim wb As Workbook
    Dim vbComp As Object
    Dim codigo As String
    
    ' Seleccionar archivo de origen
    Set fDialog = Application.FileDialog(msoFileDialogOpen)
    fDialog.Title = "Seleccionar archivo Excel (.xlsm)"
    fDialog.Filters.Clear
    fDialog.Filters.Add "Archivos de Excel", "*.xlsm"
    
    If fDialog.Show = -1 Then
        origen = fDialog.SelectedItems(1)
        
        ' Copiar archivo a destino
        destino = Left(origen, InStrRev(origen, ".")) & "_OFUSCADO.xlsm"
        FileCopy origen, destino
        
        ' Abrir el archivo de destino
        Set wb = Workbooks.Open(destino, ReadOnly:=True, Password:="")
        
        ' Procesar cada componente VBA
        For Each vbComp In wb.VBProject.VBComponents
            If vbComp.Type = vbext_ct_StdModule Or vbComp.Type = vbext_ct_ClassModule Or _
               vbComp.Type = vbext_ct_MSForm Or vbComp.Type = vbext_ct_ActiveXDesigner Then
                codigo = vbComp.CodeModule.Lines(1, vbComp.CodeModule.CountOfLines)
                codigo = OfuscarCodigo(codigo)
                vbComp.CodeModule.DeleteLines 1, vbComp.CodeModule.CountOfLines
                vbComp.CodeModule.AddFromString codigo
            End If
        Next vbComp
        
        ' Guardar y cerrar el archivo de destino
        wb.Close SaveChanges:=True
        MsgBox "Ofuscación completa. Archivo guardado como: " & destino, vbInformation
    End If
End Sub

Function OfuscarCodigo(codigo As String) As String
    Dim lineas() As String
    Dim i As Long
    Dim linea As String
    Dim nuevoCodigo As String
    Dim variableCounter As Long
    Dim renombrados As Collection
    
    ' Inicializar colección para renombrar variables
    Set renombrados = New Collection
    variableCounter = 1
    
    ' Separar el código en líneas
    lineas = Split(codigo, vbNewLine)
    
    ' Procesar cada línea
    For i = LBound(lineas) To UBound(lineas)
        linea = lineas(i)
        
        ' Eliminar comentarios
        If InStr(linea, "'") > 0 Then
            linea = Left(linea, InStr(linea, "'") - 1)
        End If
        
        ' Renombrar Private Subs y Functions
        If InStr(linea, "Private Sub ") > 0 Then
            linea = Replace(linea, "Private Sub ", "Private Sub P_" & variableCounter & "_")
            variableCounter = variableCounter + 1
        ElseIf InStr(linea, "Private Function ") > 0 Then
            linea = Replace(linea, "Private Function ", "Private Function F_" & variableCounter & "_")
            variableCounter = variableCounter + 1
        End If
        
        ' Renombrado de variables locales (simplificado)
        If InStr(linea, "Dim ") > 0 Then
            Do While InStr(linea, "Dim ") > 0
                Dim variable As String
                variable = Mid(linea, InStr(linea, "Dim ") + 4, InStr(InStr(linea, "Dim "), " As ") - InStr(linea, "Dim ") - 4)
                If Not VariableYaRenombrada(variable, renombrados) Then
                    linea = Replace(linea, variable, "v_" & variableCounter)
                    renombrados.Add variable
                    variableCounter = variableCounter + 1
                End If
            Loop
        End If
        
        ' Añadir línea procesada al nuevo código
        If Trim(linea) <> "" Then
            nuevoCodigo = nuevoCodigo & linea & vbNewLine
        End If
    Next i
    
    OfuscarCodigo = nuevoCodigo
End Function

Function VariableYaRenombrada(variable As String, ByRef renombrados As Collection) As Boolean
    Dim i As Long
    VariableYaRenombrada = False
    On Error Resume Next
    For i = 1 To renombrados.Count
        If renombrados(i) = variable Then
            VariableYaRenombrada = True
            Exit Function
        End If
    Next i
    On Error GoTo 0
End Function
