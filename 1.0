<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Tabla filtrable – Personal</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#f5f5f5;
  --ink:#222;
  --muted:#666;
  --line:#ddd;
  --head:#333;
  --headink:#fff;
  --active:#0b6eed;
  --exclude:#dc3545;
}

body{
  font-family:system-ui,Arial,sans-serif;
  margin:20px;
  background:var(--bg);
  color:var(--ink);
}

h2{margin:0 0 8px}

.meta{
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

.actions{
  margin-bottom:10px;
}

.actions button{
  padding:6px 14px;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  border:1px solid var(--active);
  background:var(--active);
  color:#fff;
  transition:.15s;
}

.actions button:hover{
  background:#094db1;
  box-shadow:0 2px 8px rgba(11,110,237,.35);
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
}

th,td{
  padding:8px 10px;
  border:1px solid var(--line);
  vertical-align:top;
}

thead th{
  background:var(--head);
  color:var(--headink);
  position:sticky;
  top:0;
  z-index:1;
}

thead input{
  width:100%;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid var(--line);
  outline:none;
  box-sizing:border-box;
}

thead input.active{
  border-color:var(--active);
  font-weight:700;
}

thead input.exclude{
  border-color:var(--exclude);
  background:#fff5f5;
}

tbody tr:nth-child(even) td{
  background:#fafafa;
}

mark{
  background:none;
  color:var(--active);
  font-weight:700;
}

.status{
  margin-top:12px;
  font-size:13px;
  color:var(--muted);
  font-weight:600;
}
</style>
</head>

<body>

<h2>Tabla filtrable con los datos de ficheros personal</h2>

<div class="meta">
  palabra · <b>+palabra</b> obligatorio · <b>&lt;&gt;palabra</b> excluir
</div>

<div class="actions">
  <button onclick="clearAllFilters()">Borrar todos los filtros</button>
</div>

<table>
<thead>
<tr>
  <th>
    <input list="dl0" placeholder="Fichero"
           onfocus="handleFocus(0)"
           oninput="handleType(0,this)">
    <datalist id="dl0"></datalist>
  </th>
  <th>
    <input list="dl1" placeholder="Código"
           onfocus="handleFocus(1)"
           oninput="handleType(1,this)">
    <datalist id="dl1"></datalist>
  </th>
  <th>
    <input list="dl2" placeholder="Formato"
           onfocus="handleFocus(2)"
           oninput="handleType(2,this)">
    <datalist id="dl2"></datalist>
  </th>
  <th>
    <input list="dl3" placeholder="Descripción"
           onfocus="handleFocus(3)"
           oninput="handleType(3,this)">
    <datalist id="dl3"></datalist>
  </th>
  <th>
    <input list="dl4" placeholder="Descripción 2"
           onfocus="handleFocus(4)"
           oninput="handleType(4,this)">
    <datalist id="dl4"></datalist>
  </th>
  <th>
    <input list="dl5" placeholder="€"
           onfocus="handleFocus(5)"
           oninput="handleType(5,this)">
    <datalist id="dl5"></datalist>
  </th>
  <th>
    <input list="dl6" placeholder="Capítulo"
           onfocus="handleFocus(6)"
           oninput="handleType(6,this)">
    <datalist id="dl6"></datalist>
  </th>
</tr>
<tr>
  <th>Fichero</th>
  <th>Código</th>
  <th>Formato</th>
  <th>Descripción</th>
  <th>Descripción 2</th>
  <th>€</th>
  <th>Capítulo</th>
</tr>
</thead>

<tbody id="tbody"></tbody>
</table>

<div class="status" id="status"></div>

<script>
const DATA=[
 ["F(XXXX) FICHERO DE PERSONAL","A001","A25","APELLIDOS","INFORMACIONES REPETITIVAS","",""],
 ["F(XXXX) FICHERO DE PERSONAL","A002","A15","NOMBRE","","",""],
 ["W(XXXX) VALORES DE REFERENCIA DEL TRATAMIENTO","0127","P9.2","LIBRE","","",""],
 ["W(XXXX) VALORES DE REFERENCIA DEL TRATAMIENTO","0128","P9.2","LIBRE","","",""],
 ["W(XXXX) VALORES DE REFERENCIA DEL TRATAMIENTO","0129","A01","TIPO DE EXPLOTACIÓN","","",""],
 ["W(XXXX) VALORES DE REFERENCIA DEL TRATAMIENTO","0130","N04","FECHA DE NOMINA","","",""]
];

const TBODY=document.getElementById("tbody");
const STATUS=document.getElementById("status");
const INPUTS=[...document.querySelectorAll("thead input")];
const FILTERS=Array(7).fill("");

let debounceTimer;

function rowMatches(row){
  for(let i=0;i<7;i++){
    const f=FILTERS[i];
    if(!f)continue;

    const cell=String(row[i]).toLowerCase();
    const norm=f.replace(/<>\s+/g,"<>");
    const parts=norm.split(/\s+/).filter(Boolean);

    for(const p of parts){
      if(p.startsWith("+")){
        if(!cell.includes(p.slice(1)))return false;
      }else if(p.startsWith("<>")){
        if(cell.includes(p.slice(2)))return false;
      }else{
        if(!cell.includes(p))return false;
      }
    }
  }
  return true;
}

function highlightText(txt,col){
  const f=FILTERS[col];
  if(!f)return txt;

  const norm=f.replace(/<>\s+/g,"<>");
  const parts=norm.split(/\s+/).filter(p=>!p.startsWith("<>"));

  let res=txt;
  for(const p of parts){
    const t=p.replace(/^\+/,"");
    if(!t)continue;
    res=res.replace(new RegExp(`(${t})`,"ig"),"<mark>$1</mark>");
  }
  return res;
}

function renderTable(){
  TBODY.innerHTML="";
  const rows=DATA.filter(rowMatches);

  for(const r of rows){
    const tr=document.createElement("tr");
    r.forEach((c,i)=>{
      const td=document.createElement("td");
      td.innerHTML=highlightText(String(c),i);
      tr.appendChild(td);
    });
    TBODY.appendChild(tr);
  }
  STATUS.textContent=`Coincidencias: ${rows.length}`;
}

function updateDatalist(col){
  const dl=document.getElementById("dl"+col);
  dl.innerHTML="";
  const counts=new Map();

  for(const row of DATA){
    if(!rowMatches(row))continue;
    const v=String(row[col]);
    counts.set(v,(counts.get(v)||0)+1);
  }

  for(const [val,n] of [...counts.entries()].sort((a,b)=>a[0].localeCompare(b[0]))){
    const opt=document.createElement("option");
    opt.value=val;
    opt.label=`${val} (${n})`;
    dl.appendChild(opt);
  }
}

function handleFocus(col){
  updateDatalist(col);
  INPUTS[col].dispatchEvent(new Event("input",{bubbles:true}));
}

function handleType(col,el){
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>{
    const v=el.value.toLowerCase().trim();
    FILTERS[col]=v;
    el.classList.toggle("active",v.length>0);
    el.classList.toggle("exclude",v.includes("<>"));
    updateDatalist(col);
    renderTable();
  },120);
}

function clearAllFilters(){
  FILTERS.fill("");
  INPUTS.forEach(i=>{
    i.value="";
    i.classList.remove("active","exclude");
  });
  renderTable();
}

document.addEventListener("keydown",e=>{
  if(e.key==="Escape") clearAllFilters();
});

renderTable();
</script>

</body>
</html>
