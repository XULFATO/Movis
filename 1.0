Dim fila As Long, colBase As Long, ultimaFila As Long
colBase = Celda_Inicial.Column
fila = Celda_Inicial.Row
ultimaFila = wsp.Cells(wsp.Rows.Count, colBase).End(xlUp).Row

Dim dict As Object
Set dict = CreateObject("Scripting.Dictionary")
Dim clave As String
Dim comboActual As String
Dim tempDict As Object

' Primera pasada: contar todas las combinaciones para cada clave
For fila = Celda_Inicial.Row To ultimaFila
    clave = Trim(wsp.Cells(fila, colBase).Value)
    comboActual = Trim(wsp.Cells(fila, colBase + 1).Value) & "|" & _
                  Trim(wsp.Cells(fila, colBase + 2).Value)
    
    If Trim(clave) <> "" And Trim(comboActual) <> "|" Then
        If Not dict.Exists(clave) Then
            Set tempDict = CreateObject("Scripting.Dictionary")
            dict.Add clave, tempDict
        End If
        
        If dict(clave).Exists(comboActual) Then
            dict(clave)(comboActual) = dict(clave)(comboActual) + 1
        Else
            dict(clave).Add comboActual, 1
        End If
    End If
Next fila

' Determinar la combinación más frecuente para cada clave
Dim comboMayoria As Object
Set comboMayoria = CreateObject("Scripting.Dictionary")
Dim maxCount As Long
Dim combo As Variant

For Each clave In dict.Keys
    maxCount = 0
    For Each combo In dict(clave).Keys
        If dict(clave)(combo) > maxCount Then
            maxCount = dict(clave)(combo)
            comboMayoria(clave) = combo
        End If
    Next combo
Next clave

' Segunda pasada: marcar las diferencias
For fila = Celda_Inicial.Row To ultimaFila
    clave = Trim(wsp.Cells(fila, colBase).Value)
    comboActual = Trim(wsp.Cells(fila, colBase + 1).Value) & "|" & _
                  Trim(wsp.Cells(fila, colBase + 2).Value)
    
    If Trim(clave) <> "" And comboMayoria.Exists(clave) Then
        If comboActual <> comboMayoria(clave) Then
            ' MARCAR ERROR (ejemplo: color rojo)
            wsp.Cells.FormatConditions.Delete
            wsp.Cells(fila, colBase).Interior.Color = RGB(173, 216, 230)
            wsp.Cells(fila, colBase + 1).Interior.Color = RGB(173, 216, 230)
            wsp.Cells(fila, colBase + 2).Interior.Color = RGB(173, 216, 230)
            Call AddOrAppendComment(wsp.Cells(fila, colBase), _
                "AVISO - Valor diferente al resto con mismo enlace contable")
        End If
    End If
Next fila
