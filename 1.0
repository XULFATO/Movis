# ==========================================================
# Buscar literales en Blueprints (versi√≥n r√°pida + resumenes)
# ==========================================================
$ErrorActionPreference = "Stop"

# ---------- Limpieza de procesos Excel previos ----------
Get-Process excel -ErrorAction SilentlyContinue | ForEach-Object { try { $_.Kill() } catch {} }

# ---------- Funciones auxiliares ----------
function Remove-Diacritics([string]$s){
    if ([string]::IsNullOrWhiteSpace($s)) { return "" }
    $d = $s.Normalize([Text.NormalizationForm]::FormD)
    ($d.ToCharArray() | Where-Object {
        [Globalization.CharUnicodeInfo]::GetUnicodeCategory($_) -ne [Globalization.UnicodeCategory]::NonSpacingMark
    }) -join ''
}
function Normalize([string]$s){ (Remove-Diacritics $s).ToLowerInvariant().Trim() }

function Ask-YesNo($prompt) {
    while ($true) {
        $r = Read-Host "$prompt (S/N)"
        if ($r -match '^[sS]$') { return $true }
        if ($r -match '^[nN]$') { return $false }
        Write-Host "   Responde S o N, por favor." -ForegroundColor DarkYellow
    }
}

# ---------- Entrada ----------
Write-Host "üîç B√∫squeda de literales en Blueprints ‚Üí hoja 'An√°lisis conceptos' (sin exportar)" -ForegroundColor Cyan

$basePath = Read-Host "üìÇ Introduce la ruta base (p.ej. R:\Proyectos)"
if (-not (Test-Path $basePath)) { Write-Host "‚ùå Ruta no v√°lida."; exit }

Write-Host "`n‚úèÔ∏è  Introduce hasta 10 literales (uno por l√≠nea). Deja vac√≠o para terminar." -ForegroundColor Yellow
$literals = @()
for ($i=1; $i -le 10; $i++){
    $lit = Read-Host ("Literal #{0}" -f $i)
    if ([string]::IsNullOrWhiteSpace($lit)) { break }
    $literals += $lit
}
if ($literals.Count -eq 0) { Write-Host "‚ùå Sin literales. Saliendo."; exit }

$stopAtFirst = Ask-YesNo "¬øParar al encontrar la primera coincidencia?"

$reDoc = '(?i)(documentaci[o√≥]n\s+implantaci[o√≥]n)'
$reAna = '(?i)(an[a√°]lisis)'

# ---------- Recorrido ----------
Write-Host "`nüìÅ Recorriendo estructura (con '_' en 4¬™ posici√≥n, orden fecha desc.)..." -ForegroundColor DarkCyan

$blueprints = @()

Get-ChildItem -Path $basePath -Directory |
  Where-Object { $_.Name.Length -ge 4 -and $_.Name[3] -eq '_' } |
  Sort-Object LastWriteTime -Descending |
  ForEach-Object {

    $dir1 = $_
    Write-Host ("‚Üí Revisando carpeta principal: {0}" -f $dir1.Name) -ForegroundColor Yellow

    Get-ChildItem -Path $dir1.FullName -Directory -ErrorAction SilentlyContinue | ForEach-Object {
        $dir2 = $_
        $docDirs = Get-ChildItem -Path $dir2.FullName -Directory -ErrorAction SilentlyContinue |
                   Where-Object { $_.Name -match $reDoc }

        foreach ($doc in $docDirs) {
            $anaDirs = Get-ChildItem -Path $doc.FullName -Directory -ErrorAction SilentlyContinue |
                       Where-Object { $_.Name -match $reAna }

            foreach ($ana in $anaDirs) {
                Write-Host ("   üìÇ Revisando subcarpeta: {0}" -f $ana.FullName) -ForegroundColor Cyan

                $found = Get-ChildItem -Path $ana.FullName -File -ErrorAction SilentlyContinue |
                         Where-Object { $_.Name -notlike '~$*' -and $_.Name -match '(?i)Blueprint.*\.(xlsx|xlsm)$' }

                foreach ($f in $found) {
                    Write-Host ("      ‚úÖ Encontrado Blueprint: {0}" -f $f.Name) -ForegroundColor Green
                    $blueprints += $f.FullName
                }
            }
        }
    }
}

if ($blueprints.Count -eq 0) {
    Write-Host "‚ö†Ô∏è No se encontraron Blueprints en la estructura esperada." -ForegroundColor DarkYellow
    exit
}

Write-Host ("   ‚Üí {0} ficheros 'Blueprint' detectados." -f $blueprints.Count) -ForegroundColor Green

# ---------- B√∫squeda optimizada ----------
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$excel.DisplayAlerts = $false
$excel.AutomationSecurity = 3  # sin macros
$excel.EnableEvents = $false

$totalEncontrados = 0
$totalBlueprintsOK = 0

foreach ($path in $blueprints) {
    try {
        Write-Host ("`nüîπ Analizando: {0}" -f $path) -ForegroundColor DarkCyan
        $wb = $excel.Workbooks.Open($path, 0, $true)

        $target = $null
        foreach ($sh in $wb.Worksheets) {
            $n = Normalize $sh.Name
            if ($n -match 'analisis' -and $n -match 'concept') { $target = $sh; break }
        }

        if (-not $target) {
            Write-Host ("‚ö†Ô∏è Sin hoja 'An√°lisis conceptos' en {0}" -f (Split-Path $path -Leaf)) -ForegroundColor DarkYellow
            $wb.Close($false) | Out-Null
            continue
        }

        $values = $target.UsedRange.Value2
        if (-not $values) {
            Write-Host "‚ö™ Hoja vac√≠a." -ForegroundColor DarkGray
            $wb.Close($false) | Out-Null
            continue
        }

        $rows = $values.GetLength(0)
        $cols = $values.GetLength(1)

        $coinc = 0

        for ($r=1; $r -le $rows; $r++) {
            for ($c=1; $c -le $cols; $c++) {
                $txt = [string]$values[$r,$c]
                if ([string]::IsNullOrWhiteSpace($txt)) { continue }
                $v = Normalize $txt
                foreach ($lit in $literals) {
                    if ($v -like ("*" + (Normalize $lit) + "*")) {
                        $coinc++
                        $totalEncontrados++
                        Write-Host ("‚úÖ '{0}' ‚Üí {1} R{2},C{3}: {4}" -f $lit, (Split-Path $path -Leaf), $r, $c, $txt) -ForegroundColor Green
                        if ($stopAtFirst) { throw "STOP_GLOBAL" }
                    }
                }
            }
        }

        $wb.Close($false) | Out-Null

        if ($coinc -gt 0) {
            Write-Host ("   ‚úîÔ∏è {0} coincidencias en este Blueprint" -f $coinc) -ForegroundColor Green
            $totalBlueprintsOK++
        } else {
            Write-Host ("   ‚ö™ Sin coincidencias en {0}" -f (Split-Path $path -Leaf)) -ForegroundColor Gray
        }
    }
    catch {
        if ($_.Exception.Message -eq "STOP_GLOBAL") { break }
        Write-Host ("‚ö†Ô∏è Error en {0}: {1}" -f (Split-Path $path -Leaf), $_.Exception.Message) -ForegroundColor DarkYellow
    }
}

# ---------- Resumen final ----------
Write-Host "`n==============================================" -ForegroundColor DarkCyan
Write-Host ("üìä Resumen final:") -ForegroundColor Cyan
Write-Host ("   Blueprints revisados : {0}" -f $blueprints.Count)
Write-Host ("   Blueprints con hallazgos : {0}" -f $totalBlueprintsOK)
Write-Host ("   Coincidencias totales : {0}" -f $totalEncontrados)
Write-Host "==============================================" -ForegroundColor DarkCyan

# ---------- Limpieza ----------
$excel.Quit()
[System.Runtime.InteropServices.Marshal]::ReleaseComObject($excel) | Out-Null
Get-Process excel -ErrorAction SilentlyContinue | ForEach-Object { try { $_.Kill() } catch {} }

Write-Host "`n‚úîÔ∏è Proceso completado sin exportar resultados." -ForegroundColor Green