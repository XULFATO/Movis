# ============================================
# Fusionar hojas "AnÃ¡lisis Conceptos" (formato, nombre archivo, sin duplicados, ajusta columna A)
# ============================================

# === CONFIGURACIÃ“N ===
$carpetaOrigen   = "C:\Ruta\A\TusExcels"              # <-- cambia esta ruta
$ficheroSalida   = "C:\Users\Javier\Pruebas\Base_Datos.xlsx"
$nombreHojaFinal = "Consolidado"

# === ARRANQUE ===
Add-Type -AssemblyName Microsoft.Office.Interop.Excel
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$excel.DisplayAlerts = $false

$wbFinal = $excel.Workbooks.Add()
$wsFinal = $wbFinal.Sheets.Item(1)
$wsFinal.Name = $nombreHojaFinal
$filaDestino = 1

$archivos = Get-ChildItem -Path $carpetaOrigen -Filter *.xls* -File -Recurse
Write-Host "ðŸ“‚ Procesando $($archivos.Count) archivos..."

foreach ($archivo in $archivos) {
    try {
        $wb = $excel.Workbooks.Open($archivo.FullName, $false, $true)
        $hoja = $null

        # Buscar hoja que coincida con "AnÃ¡lisis Conceptos"
        foreach ($h in $wb.Sheets) {
            if ($h.Name -match '(?i)an[aÃ¡]lisis\s*conceptos?') {
                $hoja = $h
                break
            }
        }

        if ($hoja -ne $null) {
            # Detectar Ãºltima fila/columna con datos
            $ultimaFila = $hoja.Cells.Find("*", $hoja.Cells.Item(1,1),
                [Type]::Missing, [Type]::Missing, 1, 2, $false,
                [Type]::Missing, [Type]::Missing).Row
            $ultimaCol = $hoja.Cells.Find("*", $hoja.Cells.Item(1,1),
                [Type]::Missing, [Type]::Missing, 2, 2, $false,
                [Type]::Missing, [Type]::Missing).Column

            # Detectar fila de inicio (busca encabezados)
            $filaInicio = 1
            for ($i = 1; $i -le [Math]::Min(10, $ultimaFila); $i++) {
                $textoFila = ($hoja.Range("A$i:X$i").Text -join " ") -replace '\s+', ' '
                if ($textoFila -match '(?i)(c[oÃ³]digo\s*adp|utilizar\s*cliente|c[oÃ³]digo\s*cliente)') {
                    $filaInicio = $i
                    break
                }
            }

            # Detectar si empieza en la columna A o B
            $colInicio = 1
            $primeraCelda = $hoja.Cells.Item($filaInicio, 1).Text
            if ([string]::IsNullOrWhiteSpace($primeraCelda)) {
                # Si la columna A estÃ¡ vacÃ­a y la tabla comienza en B
                $colInicio = 2
            }

            # Definir rango real
            $rangoOrigen = $hoja.Range($hoja.Cells.Item($filaInicio, $colInicio),
                                       $hoja.Cells.Item($ultimaFila, $ultimaCol))

            # Copiar con formato completo
            $rangoOrigen.Copy()

            # Si el origen empieza en A, pegamos en B (columna desplazada)
            if ($colInicio -eq 1) {
                $destino = $wsFinal.Cells.Item($filaDestino, 2)   # empieza en columna B
            } else {
                $destino = $wsFinal.Cells.Item($filaDestino, 2)   # tambiÃ©n B, coherencia total
            }

            $wsFinal.Paste($destino)
            try { [void]$excel.Range("A1").Select() } catch {}

            # AÃ±adir nombre de archivo en la siguiente columna disponible
            $colArchivo = $ultimaCol + 2  # +2 porque todo empieza en B
            $wsFinal.Cells.Item($filaDestino, $colArchivo) = "ArchivoOrigen"

            $filasPegadas = $rangoOrigen.Rows.Count
            for ($i = 2; $i -le $filasPegadas; $i++) {
                $wsFinal.Cells.Item($filaDestino + $i - 1, $colArchivo) = $archivo.Name
            }

            $filaDestino += $filasPegadas + 1
        }

        $wb.Close($false)
    } catch {
        Write-Host "âŒ Error procesando $($archivo.Name): $_"
    }
}

# === ELIMINAR DUPLICADOS ===
try {
    $ultimaFilaFinal = $wsFinal.Cells.Find("*", $wsFinal.Cells.Item(1,1),
        [Type]::Missing, [Type]::Missing, 1, 2, $false,
        [Type]::Missing, [Type]::Missing).Row
    $ultimaColFinal = $wsFinal.Cells.Find("*", $wsFinal.Cells.Item(1,1),
        [Type]::Missing, [Type]::Missing, 2, 2, $false,
        [Type]::Missing, [Type]::Missing).Column

    $rangoFinal = $wsFinal.Range($wsFinal.Cells.Item(1,1), $wsFinal.Cells.Item($ultimaFilaFinal, $ultimaColFinal))
    $rangoFinal.RemoveDuplicates(1..$ultimaColFinal, 1) | Out-Null
} catch {
    Write-Host "âš ï¸ No se pudo eliminar duplicados: $_"
}

# === GUARDAR Y CERRAR ===
$wbFinal.SaveAs($ficheroSalida)
$wbFinal.Close($true)
$excel.Quit()

Write-Host "âœ… Consolidado generado correctamente en:"
Write-Host "   $ficheroSalida"