Public Sub Reconstruir_Modulos_En_NuevoLibro()
    Dim ws As Worksheet
    Dim txt As String
    Dim pos As Long, nextPos As Long
    Dim modName As String, body As String
    Dim wb As Workbook
    Dim vbComp As Object
    
    Set ws = Sheets("VBA_RECONSTRUIDO")
    txt = CStr(ws.Cells(1, 1).Value)
    
    If Len(txt) = 0 Then
        MsgBox "No hay texto en VBA_RECONSTRUIDO! Ejecuta antes ReconstruirDesde_FOTO_VBA.", vbCritical
        Exit Sub
    End If
    
    Set wb = Workbooks.Add
    
    pos = 1
    Do
        pos = InStr(pos, txt, SEP_MOD, vbTextCompare)
        If pos = 0 Then Exit Do
        
        pos = pos + Len(SEP_MOD)
        nextPos = InStr(pos, txt, SEP_ENDMOD, vbTextCompare)
        If nextPos = 0 Then Exit Do
        
        modName = Mid$(txt, pos, nextPos - pos)
        pos = nextPos + Len(SEP_ENDMOD)
        
        ' El cuerpo va hasta el siguiente [[MOD: o fin
        nextPos = InStr(pos, txt, SEP_MOD, vbTextCompare)
        If nextPos = 0 Then
            body = Mid$(txt, pos)
        Else
            body = Mid$(txt, pos, nextPos - pos)
        End If
        
        body = Replace(body, SEP_NL, vbCrLf)
        
        ' Crear m칩dulo est치ndar y pegar c칩digo
        Set vbComp = wb.VBProject.VBComponents.Add(1) ' 1 = vbext_ct_StdModule
        On Error Resume Next
        vbComp.Name = modName
        On Error GoTo 0
        vbComp.CodeModule.AddFromString body
        
        If nextPos = 0 Then Exit Do
        pos = nextPos
    Loop
    
    MsgBox "He creado un libro nuevo con m칩dulos reconstruidos.", vbInformation
End Sub
