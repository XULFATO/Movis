# ============================================
# Fusionar hojas "Análisis Conceptos" en un Excel único
# ============================================

# === CONFIGURACIÓN ===
$carpetaOrigen   = "C:\Ruta\A\TusExcels"         # <-- cambia esta ruta
$ficheroSalida   = "C:\Users\Javier\Pruebas\Base_Datos.xlsx"
$columnaFiltro   = 4                              # columna D
$valoresExcluidos = @("XXXX", "ZZZZZ")            # valores a excluir
$nombreHojaFinal = "Consolidado"
$maxFilas = 100000                                # seguridad

# === ARRANQUE ===
Add-Type -AssemblyName Microsoft.Office.Interop.Excel
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$excel.DisplayAlerts = $false

$resultados = @()
$archivos = Get-ChildItem -Path $carpetaOrigen -Filter *.xls* -File
Write-Host "📂 Procesando $($archivos.Count) archivos..."

foreach ($archivo in $archivos) {
    try {
        $wb = $excel.Workbooks.Open($archivo.FullName)
        # Buscar hoja válida (Análisis / Analisis, Concepto / Conceptos)
        $hoja = $null
        foreach ($h in $wb.Sheets) {
            if ($h.Name -match '(?i)an[aá]lisis\s*conceptos?') {
                $hoja = $h
                break
            }
        }

        if ($hoja -ne $null) {
            # Calcular rango real de datos
            $ultimaFila = $hoja.UsedRange.Rows.Count
            $ultimaCol = $hoja.UsedRange.Columns.Count
            if ($ultimaFila -gt $maxFilas) { $ultimaFila = $maxFilas }

            $letraUltCol = [char](64 + $ultimaCol)
            $rango = $hoja.Range("A1:$letraUltCol$ultimaFila")
            $valores = $rango.Value2

            foreach ($fila in $valores) {
                if ($fila -eq $null -or ($fila -join '') -eq '') { continue }

                $valorFiltro = $fila[$columnaFiltro - 1]
                if ($valoresExcluidos -contains $valorFiltro) { continue }

                $filaObj = [ordered]@{}
                for ($i=0; $i -lt $ultimaCol; $i++) {
                    $colName = [char](65 + $i)
                    $filaObj["Col_$colName"] = $fila[$i]
                }
                $filaObj["ArchivoOrigen"] = $archivo.Name
                $resultados += New-Object PSObject -Property $filaObj
            }
        }
        $wb.Close($false)
    } catch {
        Write-Host "❌ Error en $($archivo.Name): $_"
    }
}

$excel.Quit()

# === Eliminar duplicados ===
if ($resultados.Count -gt 0) {
    $resultados = $resultados | Sort-Object * -Unique
}

# === Crear Excel final ===
Write-Host "📝 Creando Excel final..."
$excelOut = New-Object -ComObject Excel.Application
$excelOut.Visible = $false
$excelOut.DisplayAlerts = $false
$wbOut = $excelOut.Workbooks.Add()
$wsOut = $wbOut.Sheets.Item(1)
$wsOut.Name = $nombreHojaFinal

# Escribir cabeceras
$headers = $resultados[0].PSObject.Properties.Name
for ($j=0; $j -lt $headers.Count; $j++) {
    $wsOut.Cells.Item(1, $j + 1) = $headers[$j]
}

# Escribir datos
$row = 2
foreach ($fila in $resultados) {
    for ($j=0; $j -lt $headers.Count; $j++) {
        $valor = $fila.($headers[$j])
        if ($valor -ne $null) { $wsOut.Cells.Item($row, $j + 1) = $valor }
    }
    $row++
}

$wbOut.SaveAs($ficheroSalida)
$wbOut.Close($true)
$excelOut.Quit()

Write-Host "✅ Excel generado correctamente en:"
Write-Host "   $ficheroSalida"
Write-Host "📊 Filas exportadas: $($resultados.Count)"