# ================================================
# EXTRAER XML DE "sheet1" DE CADA EXCEL EN UNA CARPETA
# ================================================

# === CONFIGURACIÓN ===
$carpetaOrigen = "C:\Ruta\A\TusExcels"        # <-- CAMBIA ESTA RUTA
$carpetaSalida = "C:\Ruta\Salida_XML"         # <-- donde se guardarán los XML

# Crear carpeta destino si no existe
if (-not (Test-Path $carpetaSalida)) {
    New-Item -ItemType Directory -Path $carpetaSalida | Out-Null
}

# Obtener todos los Excel .xlsx y .xlsm
$archivos = Get-ChildItem -Path $carpetaOrigen -Recurse -Include *.xlsx, *.xlsm | Where-Object { $_.Name -notmatch '^~\$' }

Write-Host "`nProcesando $($archivos.Count) archivos Excel..." -ForegroundColor Cyan

foreach ($archivo in $archivos) {
    try {
        Write-Host "📄 $($archivo.Name)" -ForegroundColor Yellow

        $tempDir = Join-Path $env:TEMP ("xlsextract_" + [guid]::NewGuid().ToString())
        New-Item -ItemType Directory -Path $tempDir | Out-Null

        # Copiar y renombrar como zip temporal
        $tempZip = Join-Path $tempDir ($archivo.BaseName + ".zip")
        Copy-Item $archivo.FullName -Destination $tempZip -Force

        # Descomprimir contenido
        Expand-Archive -Path $tempZip -DestinationPath $tempDir -Force

        # Buscar el XML de la hoja principal
        $xmlPath = Join-Path $tempDir "xl\worksheets\sheet1.xml"

        if (Test-Path $xmlPath) {
            $destXml = Join-Path $carpetaSalida ($archivo.BaseName + ".xml")
            Copy-Item $xmlPath -Destination $destXml -Force
            Write-Host "   ✓ Extraído como $($archivo.BaseName).xml" -ForegroundColor Green
        } else {
            Write-Host "   ⚠ No se encontró sheet1.xml en $($archivo.Name)" -ForegroundColor DarkYellow
        }

        # Limpiar temporales
        Remove-Item $tempDir -Recurse -Force

    } catch {
        Write-Host "   ❌ Error procesando $($archivo.Name): $($_.Exception.Message)" -ForegroundColor Red
    }
}

Write-Host "`n🏁 Proceso completado. Archivos XML en: $carpetaSalida" -ForegroundColor Cyan