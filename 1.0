Add-Type -AssemblyName Microsoft.Office.Interop.Excel
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$excel.DisplayAlerts = $false

# CAMBIA esta ruta por uno de los Excel que sabes que tiene la hoja correcta
$fichero = "C:\Ruta\A\TusExcels\ejemplo_valido.xlsx"
$wb = $excel.Workbooks.Open($fichero, $false, $true)

# Busca hoja tipo "Análisis Conceptos"
$hoja = $null
foreach ($h in $wb.Sheets) {
    if ($h.Name -match '(?i)an[aá]lisis\s*conceptos?') { $hoja = $h; break }
}
if ($hoja -eq $null) {
    Write-Host "❌ Hoja no encontrada"
    $wb.Close($false); $excel.Quit(); exit
}

# Detecta última fila/columna
$ultima = $hoja.Cells.Find("*")
if ($ultima -eq $null) {
    Write-Host "❌ Hoja vacía"
    $wb.Close($false); $excel.Quit(); exit
}

$ultimaFila = $ultima.Row
$ultimaCol  = $hoja.Cells.Find("*", $null, $null, $null, 2, 2).Column
$filaInicio = 1
for ($i=1; $i -le [Math]::Min(10,$ultimaFila); $i++){
    $textoFila = ($hoja.Range("A$i:X$i").Text -join " ") -replace '\s+',' '
    if ($textoFila -match '(?i)(c[oó]digo\s*adp|utilizar\s*cliente|c[oó]digo\s*cliente)'){
        $filaInicio=$i;break
    }
}

Write-Host "Hoja encontrada:" $hoja.Name
Write-Host "Fila inicio:" $filaInicio "  Última fila:" $ultimaFila "  Última col:" $ultimaCol
Write-Host "Primeras 5 filas:"
$rango=$hoja.Range($hoja.Cells.Item($filaInicio,1),$hoja.Cells.Item([Math]::Min($filaInicio+4,$ultimaFila),$ultimaCol))
$rango.Value2 | Format-Table -AutoSize

$wb.Close($false); $excel.Quit()