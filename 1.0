# ============================================
# Fusionar hojas "An√°lisis Conceptos" manteniendo formato
# ============================================

# === CONFIGURACI√ìN ===
$carpetaOrigen   = "C:\Ruta\A\TusExcels"           # <-- cambia esta ruta
$ficheroSalida   = "C:\Users\Javier\Pruebas\Base_Datos.xlsx"
$columnaFiltro   = 4                                # Columna D
$valoresExcluidos = @("XXXX", "ZZZZZ")              # Valores a excluir
$nombreHojaFinal = "Consolidado"

# === INICIO ===
Add-Type -AssemblyName Microsoft.Office.Interop.Excel
$excel = New-Object -ComObject Excel.Application
$excel.Visible = $false
$excel.DisplayAlerts = $false

$wbFinal = $excel.Workbooks.Add()
$wsFinal = $wbFinal.Sheets.Item(1)
$wsFinal.Name = $nombreHojaFinal
$filaDestino = 1

$archivos = Get-ChildItem -Path $carpetaOrigen -Filter *.xls* -File
Write-Host "üìÇ Procesando $($archivos.Count) archivos..."

foreach ($archivo in $archivos) {
    try {
        $wb = $excel.Workbooks.Open($archivo.FullName, $false, $true)
        $hoja = $null

        # Buscar hoja que coincida con "An√°lisis Conceptos" (tildes, plural, etc.)
        foreach ($h in $wb.Sheets) {
            if ($h.Name -match '(?i)an[a√°]lisis\s*conceptos?') {
                $hoja = $h
                break
            }
        }

        if ($hoja -ne $null) {
            # Detectar √∫ltima fila y columna con datos
            $ultimaFila = $hoja.Cells.Find("*", $hoja.Cells.Item(1,1),
                [Type]::Missing, [Type]::Missing, 1, 2, $false,
                [Type]::Missing, [Type]::Missing).Row
            $ultimaCol = $hoja.Cells.Find("*", $hoja.Cells.Item(1,1),
                [Type]::Missing, [Type]::Missing, 2, 2, $false,
                [Type]::Missing, [Type]::Missing).Column

            $rangoOrigen = $hoja.Range($hoja.Cells.Item(1,1), $hoja.Cells.Item($ultimaFila, $ultimaCol))

            # Aplicar filtro temporal para excluir valores
            $hoja.AutoFilterMode = $false
            $rangoOrigen.AutoFilter(4, "<>XXXX", 7) | Out-Null
            $rangoOrigen.AutoFilter(4, "<>ZZZZZ", 7) | Out-Null

            # Copiar el rango visible (con formato)
            $rangoVisible = $rangoOrigen.SpecialCells(12) # xlCellTypeVisible = 12
            $rangoVisible.Copy()

            # Pegar en el consolidado (manteniendo formato)
            $destino = $wsFinal.Cells.Item($filaDestino, 1)
            $wsFinal.Paste($destino)
            $excel.CutCopyMode = $false

            # A√±adir nombre de archivo en la siguiente columna vac√≠a
            $colArchivo = $ultimaCol + 1
            $wsFinal.Cells.Item($filaDestino, $colArchivo) = "ArchivoOrigen"
            for ($i = 2; $i -le ($rangoVisible.Rows.Count); $i++) {
                $wsFinal.Cells.Item($filaDestino + $i - 1, $colArchivo) = $archivo.Name
            }

            # Avanzar fila destino
            $filaDestino += $rangoVisible.Rows.Count + 1
        }

        $wb.Close($false)
    } catch {
        Write-Host "‚ùå Error procesando $($archivo.Name): $_"
    }
}

# === Guardar y cerrar ===
$wbFinal.SaveAs($ficheroSalida)
$wbFinal.Close($true)
$excel.Quit()

Write-Host "‚úÖ Consolidado generado en: $ficheroSalida"