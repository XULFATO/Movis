# --- CONFIGURACI√ìN INICIAL ---
Add-Type -AssemblyName Microsoft.Office.Interop.Excel

Write-Host "üîç B√∫squeda en ficheros 'Blueprint' dentro de subcarpetas" -ForegroundColor Cyan
$path = Read-Host "üìÇ Introduce la ruta base (ej. R:\Proyectos\Planos)"
if (-not (Test-Path $path)) { Write-Host "Ruta no v√°lida. Saliendo."; exit }

# --- PREGUNTAR LITERALES ---
$literals = @()
for ($i=1; $i -le 10; $i++) {
    $lit = Read-Host "Introduce literal n¬∫ $i (deja vac√≠o para terminar)"
    if ([string]::IsNullOrWhiteSpace($lit)) { break }
    $literals += $lit
}

if ($literals.Count -eq 0) { Write-Host "No se ha introducido ning√∫n literal. Saliendo."; exit }

# --- OPCI√ìN PARAR O NO ---
$stopFirst = Read-Host "¬øParar al encontrar el primer resultado? (S/N)"
$stopFirst = $stopFirst -match "^[sS]"

# --- RESULTADOS ---
$resultados = @()

# --- B√öSQUEDA ---
foreach ($literal in $literals) {
    Write-Host "`nBuscando literal: '$literal' ..." -ForegroundColor Yellow

    Get-ChildItem -Path $path -Recurse -Filter "*Blueprint*.xlsx" | ForEach-Object {
        try {
            if (Select-String -Path $_.FullName -Pattern $literal -Quiet) {
                Write-Host "‚úÖ Encontrado en: $($_.FullName)" -ForegroundColor Green
                $resultados += [PSCustomObject]@{
                    Fichero = $_.FullName
                    Literal = $literal
                }
                if ($stopFirst) { throw "StopSearch" }
            }
        } catch {
            if ($_.Exception.Message -eq "StopSearch") { throw $_ }
        }
    }
}

# --- GUARDAR RESULTADOS EN EXCEL ---
if ($resultados.Count -gt 0) {
    $excel = New-Object -ComObject Excel.Application
    $excel.Visible = $false
    $wb = $excel.Workbooks.Add()
    $ws = $wb.Sheets.Item(1)
    $ws.Name = "Resultados"

    $ws.Cells.Item(1,1) = "Fichero"
    $ws.Cells.Item(1,2) = "Literal encontrado"

    $row = 2
    foreach ($r in $resultados) {
        $ws.Cells.Item($row,1) = $r.Fichero
        $ws.Cells.Item($row,2) = $r.Literal
        $row++
    }

    $outFile = Join-Path $env:USERPROFILE "Desktop\Resultados_Blueprint.xlsx"
    $wb.SaveAs($outFile)
    $wb.Close($false)
    $excel.Quit()
    [System.Runtime.Interopservices.Marshal]::ReleaseComObject($excel) | Out-Null

    Write-Host "`nüìÅ Archivo generado en: $outFile" -ForegroundColor Cyan
} else {
    Write-Host "`n‚ö†Ô∏è No se encontraron coincidencias." -ForegroundColor DarkYellow
}