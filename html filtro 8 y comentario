Option Explicit

Public Function Quick3270_Captura_TODO() As Boolean
    On Error Resume Next

    Dim progIDs As Variant
    progIDs = Array( _
        "Quick3270.Application", _
        "Quick3270.Session", _
        "Quick3270", _
        "Q3270.Application", _
        "Q3270.Session", _
        "pcsg3270.Application", _
        "HostAccess.Application", _
        "IBM3270.Application", _
        "EHLLAPI.Application" _
    )

    Dim root As Object, scr As Object
    Dim i As Long

    ' ==========
    ' 1) ENGANCHE PROGID
    ' ==========
    For i = LBound(progIDs) To UBound(progIDs)
        Set root = Nothing
        Set root = GetObject(, progIDs(i))
        If Not root Is Nothing Then
            MsgBox "Enganchado con GetObject: " & progIDs(i)
            Exit For
        End If
    Next i

    If root Is Nothing Then
        For i = LBound(progIDs) To UBound(progIDs)
            Set root = Nothing
            Set root = CreateObject(progIDs(i))
            If Not root Is Nothing Then
                MsgBox "Creado con CreateObject: " & progIDs(i)
                Exit For
            End If
        Next i
    End If

    If root Is Nothing Then
        MsgBox "❌ No se pudo enganchar ningún ProgID"
        Quick3270_Captura_TODO = False
        Exit Function
    End If

    ' ==========
    ' 2) INTENTAR OBTENER SCREEN
    ' ==========
    Set scr = Nothing
    Set scr = CallByName(root, "Screen", VbGet)
    If scr Is Nothing Then Set scr = CallByName(root, "ActiveSession", VbGet)
    If Not scr Is Nothing Then
        Set scr = CallByName(scr, "Screen", VbGet)
    End If
    If scr Is Nothing Then Set scr = root

    MsgBox "Objeto usado para captura: " & TypeName(scr)

    Dim txt As String, r As Long
    Dim rows As Long, cols As Long

    ' ==========
    ' 3) PROPIEDADES DIRECTAS
    ' ==========
    txt = ""
    txt = CallByName(scr, "Text", VbGet)
    MsgBox "Intento .Text" & vbCrLf & Left(txt, 1000)

    txt = ""
    txt = CallByName(scr, "TextString", VbGet)
    MsgBox "Intento .TextString" & vbCrLf & Left(txt, 1000)

    ' ==========
    ' 4) MÉTODOS SIN COORDENADAS
    ' ==========
    txt = ""
    txt = CallByName(scr, "GetText", VbMethod)
    MsgBox "Intento GetText()" & vbCrLf & Left(txt, 1000)

    txt = ""
    txt = CallByName(scr, "GetScreenText", VbMethod)
    MsgBox "Intento GetScreenText()" & vbCrLf & Left(txt, 1000)

    txt = ""
    CallByName scr, "CopyScreen", VbMethod
    Dim clip As Object
    Set clip = CreateObject("MSForms.DataObject")
    clip.GetFromClipboard
    txt = clip.GetText
    MsgBox "Intento CopyScreen + Clipboard" & vbCrLf & Left(txt, 1000)

    ' ==========
    ' 5) GETSTRING MASIVO
    ' ==========
    rows = 24: cols = 80
    rows = CallByName(scr, "Rows", VbGet)
    cols = CallByName(scr, "Cols", VbGet)

    txt = ""
    txt = CallByName(scr, "GetString", VbMethod, 1, 1, rows * cols)
    MsgBox "Intento GetString(1,1," & rows * cols & ")" & vbCrLf & Left(txt, 1000)

    ' ==========
    ' 6) GETSTRING POR FILAS (CLÁSICO 3270)
    ' ==========
    txt = ""
    For r = 1 To rows
        txt = txt & CallByName(scr, "GetString", VbMethod, r, 1, cols) & vbCrLf
    Next r
    MsgBox "Intento GetString por filas" & vbCrLf & Left(txt, 1000)

    ' ==========
    ' 7) OTROS NOMBRES FRECUENTES
    ' ==========
    txt = ""
    txt = CallByName(scr, "ReadScreen", VbMethod)
    MsgBox "Intento ReadScreen()" & vbCrLf & Left(txt, 1000)

    txt = ""
    txt = CallByName(scr, "DumpScreen", VbMethod)
    MsgBox "Intento DumpScreen()" & vbCrLf & Left(txt, 1000)

    MsgBox "✔ FIN DE TODAS LAS PRUEBAS"
    Quick3270_Captura_TODO = True
End Function
