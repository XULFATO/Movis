Sub ImportarHojaContenidoDesdeOtroExcelAbierto()
    Dim wbActual As Workbook
    Dim wb As Workbook
    Dim librosDisponibles As Collection
    Dim nombresLibros As Collection
    Dim i As Integer
    Dim seleccion As Variant
    Dim hojaContenido As Worksheet
    Dim hojaExistente As Worksheet
    Dim nombreNuevo As String
    Dim contador As Integer
    Dim nombreBase As String
    Dim encontrado As Boolean
    
    Set wbActual = ThisWorkbook
    Set librosDisponibles = New Collection
    Set nombresLibros = New Collection

    ' Paso 1: Recorrer todos los libros abiertos (excepto el actual)
    For Each wb In Application.Workbooks
        If wb.Name <> wbActual.Name Then
            librosDisponibles.Add wb
            nombresLibros.Add wb.Name
        End If
    Next wb

    ' Validación
    If librosDisponibles.Count = 0 Then
        MsgBox "No hay otros libros de Excel abiertos.", vbExclamation
        Exit Sub
    End If

    ' Paso 2: Mostrar lista al usuario
    Dim prompt As String
    prompt = "Selecciona el libro del que deseas importar la hoja 'contenido':" & vbCrLf & vbCrLf
    For i = 1 To nombresLibros.Count
        prompt = prompt & i & ". " & nombresLibros(i) & vbCrLf
    Next i

    seleccion = InputBox(prompt, "Seleccionar libro")

    If Not IsNumeric(seleccion) Or seleccion < 1 Or seleccion > nombresLibros.Count Then
        MsgBox "Selección no válida.", vbCritical
        Exit Sub
    End If

    Set wb = librosDisponibles(CInt(seleccion))

    ' Paso 3: Verificar si el libro seleccionado tiene hoja "contenido"
    On Error Resume Next
    Set hojaContenido = wb.Sheets("contenido")
    On Error GoTo 0

    If hojaContenido Is Nothing Then
        MsgBox "El libro seleccionado no tiene una hoja llamada 'contenido'.", vbExclamation
        Exit Sub
    End If

    ' Paso 4: Verificar si el libro actual ya tiene hoja "contenido"
    On Error Resume Next
    Set hojaExistente = wbActual.Sheets("contenido")
    On Error GoTo 0

    If Not hojaExistente Is Nothing Then
        ' Buscar nombre nuevo con formato XX_OLD_contenido
        nombreBase = "contenido"
        encontrado = False
        For contador = 1 To 99
            nombreNuevo = Format(contador, "00") & "_OLD_" & nombreBase
            If Not HojaExiste(nombreNuevo, wbActual) Then
                hojaExistente.Name = nombreNuevo
                encontrado = True
                Exit For
            End If
        Next contador
        
        If Not encontrado Then
            MsgBox "No se pudo renombrar la hoja 'contenido'. Hay demasiadas versiones anteriores (hasta 99).", vbCritical
            Exit Sub
        End If
    End If

    ' Paso 5: Copiar la hoja "contenido" del libro seleccionado al actual
    hojaContenido.Copy After:=wbActual.Sheets(wbActual.Sheets.Count)
    
    MsgBox "La hoja 'contenido' ha sido copiada correctamente desde '" & wb.Name & "'.", vbInformation
End Sub

Function HojaExiste(nombreHoja As String, libro As Workbook) As Boolean
    Dim hoja As Worksheet
    HojaExiste = False
    For Each hoja In libro.Sheets
        If LCase(hoja.Name) = LCase(nombreHoja) Then
            HojaExiste = True
            Exit Function
        End If
    Next hoja
End Function
