Option Explicit

' ==================================================================================
' MOTOR DE OFUSCACIÓN Y AUDITORÍA VBA - VERSIÓN ULTRA-ESTABLE
' ==================================================================================

Private Const TECLA_AUDITORIA As String = "^+K"
Private Const NOMBRE_MODULO_KERNEL As String = "mdl_System_Kernel"
Private Const PREFIJO_VARIABLES As String = "var_sys_"
Private Const LISTA_PROTEGIDA As String = "Workbook_Open,Workbook_Close,Auto_Open,Auto_Close,ThisWorkbook,Sheet1,Sheet2,Sheet3,mdl_System_Kernel,Kernel_Registrar_Evento,Kernel_Mostrar_Auditoria"

Private Type TipoMapeo
    NombreOriginal As String
    NombreNuevo As String
End Type

Private ArrayMapeo() As TipoMapeo
Private ContadorMapeo As Long

Public Sub Ejecutar_Motor_Proteccion()
    Dim rutaOrigen As Variant, rutaDestino As Variant
    Dim libroDestino As Workbook
    Dim t As Double: t = Timer
    
    rutaOrigen = Application.GetOpenFilename("Excel (*.xlsm), *.xlsm")
    If rutaOrigen = False Then Exit Sub
    
    rutaDestino = Application.GetSaveAsFilename("Protegido.xlsm", "Excel (*.xlsm), *.xlsm")
    If rutaDestino = False Then Exit Sub
    
    On Error GoTo Errores
    ConfigurarApp False
    
    ' Clonar archivo
    FileCopy rutaOrigen, rutaDestino
    Set libroDestino = Workbooks.Open(rutaDestino)
    
    ' Reiniciar Diccionario
    ContadorMapeo = 0
    ReDim ArrayMapeo(0)
    
    ' FASES
    Fase1_Kernel libroDestino
    Fase2_Diccionario libroDestino
    Fase3_Ofuscar libroDestino
    Fase4_Botones libroDestino
    Fase5_Nombres libroDestino
    
    libroDestino.Save
    libroDestino.Close
    ConfigurarApp True
    
    MsgBox "Protección exitosa en " & Format(Timer - t, "0.0") & "s." & vbCrLf & "Atajo: Ctrl+Shift+K", 64
    Exit Sub
Errores:
    ConfigurarApp True
    MsgBox "Error Crítico: " & Err.Description, 16
End Sub

Private Sub Fase1_Kernel(ByRef wb As Workbook)
    Dim c As Object
    On Error Resume Next
    wb.VBProject.VBComponents.Remove wb.VBProject.VBComponents(NOMBRE_MODULO_KERNEL)
    On Error GoTo 0
    
    Set c = wb.VBProject.VBComponents.Add(1)
    c.Name = NOMBRE_MODULO_KERNEL
    With c.CodeModule
        .InsertLines 1, "Public Sub Kernel_Registrar_Evento(n As String)"
        .InsertLines 2, "  On Error Resume Next: Dim p As Object: Set p = ThisWorkbook.CustomDocumentProperties(n)"
        .InsertLines 3, "  If p Is Nothing Then ThisWorkbook.CustomDocumentProperties.Add n, False, 3, 1 Else p.Value = p.Value + 1"
        .InsertLines 4, "End Sub"
        .InsertLines 5, "Public Sub Kernel_Mostrar_Auditoria()"
        .InsertLines 6, "  Dim p, r: r = ""LOGS:"" & vbCr: For Each p In ThisWorkbook.CustomDocumentProperties: r = r & p.Name & "": "" & p.Value & vbCr: Next: MsgBox r"
        .InsertLines 7, "End Sub"
    End With
    
    Set c = wb.VBProject.VBComponents("ThisWorkbook").CodeModule
    c.DeleteLines 1, c.CountOfLines
    c.InsertLines 1, "Private Sub Workbook_Open(): Application.OnKey """ & TECLA_AUDITORIA & """, ""Kernel_Mostrar_Auditoria"": Call Kernel_Registrar_Evento(""Aperturas""): End Sub"
End Sub

Private Sub Fase2_Diccionario(ByRef wb As Workbook)
    Dim comp As Object, i As Long, re As Object, ms As Object, m As Object
    Set re = CreateObject("VBScript.RegExp")
    re.Global = True: re.IgnoreCase = True
    
    For Each comp In wb.VBProject.VBComponents
        If Not InStr(LISTA_PROTEGIDA, comp.Name) > 0 Then AddDict comp.Name
        If comp.CodeModule.CountOfLines > 0 Then
            re.Pattern = "(?:Sub|Function|Dim|Const)\s+([a-zA-Z_][a-zA-Z0-9_]{2,})"
            Set ms = re.Execute(comp.CodeModule.Lines(1, comp.CodeModule.CountOfLines))
            For Each m In ms: AddDict m.SubMatches(0): Next
        End If
    Next
End Sub

Private Sub Fase3_Ofuscar(ByRef wb As Workbook)
    Dim comp As Object, cm As Object, i As Long, ln As String, full As String, p As String
    For Each comp In wb.VBProject.VBComponents
        If comp.Name <> NOMBRE_MODULO_KERNEL And comp.Name <> "ThisWorkbook" Then
            Set cm = comp.CodeModule: full = ""
            For i = 1 To cm.CountOfLines
                ln = cm.Lines(i, 1)
                If InStr(ln, "'") > 0 Then ln = Left(ln, InStr(ln, "'") - 1)
                ln = Trim(Replace(ln, vbTab, " "))
                If ln <> "" Then
                    p = GetProc(ln)
                    ln = ApplyMap(ln)
                    full = full & ln & vbCrLf
                    If p <> "" And Not InStr(LISTA_PROTEGIDA, p) > 0 Then full = full & "Call Kernel_Registrar_Evento(""" & p & """)" & vbCrLf
                End If
            Next
            cm.DeleteLines 1, cm.CountOfLines
            If full <> "" Then cm.AddFromString full
        End If
    Next
End Sub

Private Sub Fase4_Botones(ByRef wb As Workbook)
    Dim s As Shape, w As Worksheet, a As String, n As String
    For Each w In wb.Worksheets
        For Each s In w.Shapes
            On Error Resume Next
            a = s.OnAction: If a <> "" Then
                If InStr(a, "!") > 0 Then a = Mid(a, InStr(a, "!") + 1)
                n = GetMap(Replace(a, "'", "")): If n <> "" Then s.OnAction = "'" & wb.Name & "'!" & n
            End If
        Next
    Next
End Sub

Private Sub Fase5_Nombres(ByRef wb As Workbook)
    Dim c As Object, n As String
    For Each c In wb.VBProject.VBComponents
        If Not InStr(LISTA_PROTEGIDA, c.Name) > 0 And c.Name <> "ThisWorkbook" Then
            n = GetMap(c.Name): If n <> "" Then c.Name = n
        End If
    Next
End Sub

' --- HELPERS ---
Private Sub AddDict(o As String)
    Dim i As Long
    If InStr(LISTA_PROTEGIDA, o) > 0 Then Exit Sub
    For i = 0 To ContadorMapeo - 1: If ArrayMapeo(i).NombreOriginal = o Then Exit Sub
    Next
    ReDim Preserve ArrayMapeo(ContadorMapeo)
    ArrayMapeo(ContadorMapeo).NombreOriginal = o
    ArrayMapeo(ContadorMapeo).NombreNuevo = PREFIJO_VARIABLES & RndStr(8)
    ContadorMapeo = ContadorMapeo + 1
End Sub

Private Function ApplyMap(t As String) As String
    Dim i As Long, re As Object: Set re = CreateObject("VBScript.RegExp")
    re.Global = True: ApplyMap = t
    For i = 0 To ContadorMapeo - 1
        re.Pattern = "\b" & ArrayMapeo(i).NombreOriginal & "\b"
        ApplyMap = re.Replace(ApplyMap, ArrayMapeo(i).NombreNuevo)
    Next
End Function

Private Function GetMap(o As String) As String
    Dim i As Long
    For i = 0 To ContadorMapeo - 1: If ArrayMapeo(i).NombreOriginal = o Then GetMap = ArrayMapeo(i).NombreNuevo: Exit Function
    Next
End Function

Private Function RndStr(l As Long) As String
    Dim i As Long: For i = 1 To l: RndStr = RndStr & Chr(Int(Rnd * 26) + 97): Next
End Function

Private Function GetProc(l As String) As String
    If InStr(1, l, "Sub ", 1) > 0 Then GetProc = Split(Split(l, "Sub ")(1), "(")(0)
    If InStr(1, l, "Function ", 1) > 0 Then GetProc = Split(Split(l, "Function ")(1), "(")(0)
    GetProc = Trim(GetProc)
End Function

Private Sub ConfigurarApp(st As Boolean)
    Application.ScreenUpdating = st: Application.EnableEvents = st
    Application.Calculation = IIf(st, -4105, -4135)
End Sub
