Option Explicit

' ==================================================================================
' MOTOR DE PROTECCIÓN VBA - VERSIÓN 5.4 (SENTINEL CORE - FINAL)
' ==================================================================================
' - Fix de Property Default (Colecciones y Clases avanzadas)
' - Motor Core No-Recursivo para Rem inline
' - Soporte para Namespaces complejos (MSForms.TextBox, ADODB.Recordset.Fields)
' - Blindaje total de sintaxis VBA Industrial
' ==================================================================================

Private Const NOMBRE_MODULO_KERNEL As String = "mdl_System_Kernel"
Private Const PREFIJO_SYS As String = "vs_"
Private Const LLAMADA_KERNEL As String = "Call LogEv(""Apertura"")"

' Keywords y Objetos Protegidos
Private Const VBA_KEYWORDS As String = "|If|Then|Else|End|Sub|Function|Dim|As|Integer|String|Long|Double|Boolean|Variant|Object|On|Error|GoTo|Resume|Next|For|Each|In|Loop|Do|While|Until|Select|Case|Const|Public|Private|Static|ByVal|ByRef|Optional|ParamArray|Call|Set|New|Exit|True|False|Not|And|Or|Xor|Step|Mod|With|Stop|Attribute|VB_Name|Type|Enum|Property|Let|Get|Friend|Declare|Lib|Alias|Option|Explicit|Compare|Base|Implements|Erase|Redim|Preserve|Me|Rem|Err|Nothing|Is|Default|"
Private Const OBJETOS_PROTEGIDOS As String = "|Range|Cells|Value|Count|Name|ActiveSheet|ThisWorkbook|Sheets|Workbooks|MsgBox|Debug|Print|Left|Right|Mid|Len|Chr|Asc|Val|Str|CInt|CLng|CDbl|CBool|CDate|CVar|CSng|SetFocus|Clear|Delete|Copy|Paste|Select|Activate|"

Private Type TipoMapeo
    Original As String
    Nuevo As String
End Type

Private Map() As TipoMapeo
Private MapCount As Long

Public Sub Ejecutar_Motor_Proteccion()
    Dim rOrig As Variant, rDest As Variant, wbD As Workbook
    If Not VerificarAccesoEscritura() Then Exit Sub
    
    rOrig = Application.GetOpenFilename("Excel (*.xlsm), *.xlsm")
    If rOrig = False Then Exit Sub
    rDest = Application.GetSaveAsFilename("Protegido.xlsm", "Excel (*.xlsm), *.xlsm")
    If rDest = False Then Exit Sub
    
    On Error GoTo Errores
    ToggleSystem False
    
    If Dir(rDest) <> "" Then Kill rDest
    FileCopy rOrig, rDest
    Set wbD = Workbooks.Open(rDest)
    
    MapCount = 0: ReDim Map(0)
    
    ' FASES SENTINEL CORE
    Fase1_InyectarKernel_V54 wbD
    Fase2_Escanear_V54 wbD
    Fase3_Ofuscar_V54 wbD
    Fase4_RepararBotones_V54 wbD
    
    wbD.Save: wbD.Close
    ToggleSystem True
    MsgBox "Sentinel V5.4: Motor Core Blindado con éxito.", 64
    Exit Sub
Errores:
    ToggleSystem True
    MsgBox "ERROR CRÍTICO: " & Err.Description, 16
End Sub

' FASE 1: Detección y Normalización de Inyección
Private Sub Fase1_InyectarKernel_V54(ByRef wb As Workbook)
    Dim c As Object, cm As Object, i As Long, inicioBody As Long, kindFound As Long, lNorm As String
    On Error Resume Next
    wb.VBProject.VBComponents.Remove wb.VBProject.VBComponents(NOMBRE_MODULO_KERNEL)
    On Error GoTo 0
    
    Set c = wb.VBProject.VBComponents.Add(1): c.Name = NOMBRE_MODULO_KERNEL
    c.CodeModule.AddFromString "Public Sub LogEv(n As String)" & vbCrLf & _
        "On Error Resume Next: Dim p As Object: Set p = ThisWorkbook.CustomDocumentProperties(n)" & vbCrLf & _
        "If p Is Nothing Then ThisWorkbook.CustomDocumentProperties.Add n, False, 3, 1 Else p.Value = p.Value + 1" & vbCrLf & _
        "End Sub"

    Set cm = wb.VBProject.VBComponents("ThisWorkbook").CodeModule
    inicioBody = 0
    For i = 0 To 3
        On Error Resume Next
        inicioBody = cm.ProcBodyLine("Workbook_Open", i)
        On Error GoTo 0
        If inicioBody > 0 Then: kindFound = i: Exit For: End If
    Next i
    
    If inicioBody = 0 Then
        cm.AddFromString vbCrLf & "Private Sub Workbook_Open()" & vbCrLf & "  " & LLAMADA_KERNEL & vbCrLf & "End Sub"
    Else
        Dim existe As Boolean: existe = False
        For i = inicioBody To inicioBody + cm.ProcCountLines("Workbook_Open", kindFound) - 1
            lNorm = LCase(Replace(Replace(Replace(cm.Lines(i, 1), " ", ""), vbTab, ""), "_", ""))
            If InStr(1, lNorm, "logev(""apertura"")") > 0 Then existe = True: Exit For
        Next i
        If Not existe Then cm.InsertLines inicioBody + 1, "  " & LLAMADA_KERNEL
    End If
End Sub

' FASE 2: Escaneo Industrial (Fix 1 y 3: Namespaces y Property Default)
Private Sub Fase2_Escanear_V54(ByRef wb As Workbook)
    Dim comp As Object, i As Long, ln As String, ms As Object, m As Object
    
    Dim reProc As Object: Set reProc = CreateObject("VBScript.RegExp")
    reProc.Pattern = "\b(?:Sub|Function)\s+([a-zA-Z_][a-zA-Z0-9_]{2,})\b": reProc.IgnoreCase = True: reProc.Global = True
    
    ' Fix 3: Soporte para 'Default Property'
    Dim reProp As Object: Set reProp = CreateObject("VBScript.RegExp")
    reProp.Pattern = "\b(?:Public|Private|Friend)?\s*Property\s+(?:Default\s+)?(?:Get|Let|Set)\s+([a-zA-Z_][a-zA-Z0-9_]{2,})\b": reProp.IgnoreCase = True: reProp.Global = True
    
    For Each comp In wb.VBProject.VBComponents
        If comp.CodeModule.CountOfLines > 0 Then
            For i = 1 To comp.CodeModule.CountOfLines
                ln = comp.CodeModule.Lines(i, 1)
                Set ms = reProc.Execute(ln): For Each m In ms: AddToMap m.SubMatches(0): Next
                Set ms = reProp.Execute(ln): For Each m In ms: AddToMap m.SubMatches(0): Next
                
                If RegexTest(ln, "\b(Dim|Static|Const|Public|Private)\b") Then
                    ExtraerVariablesV54 ln
                End If
            Next i
        End If
    Next
End Sub

Private Sub ExtraerVariablesV54(ByVal linea As String)
    Dim v As Variant, i As Long, seg As String, id As String
    seg = linea: If InStr(seg, "'") > 0 Then seg = Left(seg, InStr(seg, "'") - 1)
    If InStr(seg, ":") > 0 Then seg = Left(seg, InStr(seg, ":") - 1)
    
    seg = RegexReplace(seg, "\b(Dim|Static|Const|Public|Private)\b", "")
    
    v = Split(seg, ",")
    For i = 0 To UBound(v)
        id = Trim(v(i))
        ' Fix 1: Patrón laxo para Namespaces con puntos (A-Z0-9_.)
        id = RegexReplace(id, "\bAs\s+New\s+[A-Za-z0-9_.]+\b", "")
        id = RegexReplace(id, "\bAs\s+[A-Za-z0-9_.]+\b", "")
        id = RegexReplace(id, "\bNew\s+[A-Za-z0-9_.]+\b", "")
        
        id = Split(id, " ")(0): id = Split(id, "(")(0): id = Split(id, "=")(0)
        id = Replace(Replace(Replace(Replace(Replace(Replace(id, "%", ""), "$", ""), "!", ""), "#", ""), "@", ""), "&", "")
        
        If Len(id) >= 2 Then AddToMap id
    Next i
End Sub

' FASE 3: Ofuscación (Fix 2: Eliminación de Recursión en Rem)
Private Sub Fase3_Ofuscar_V54(ByRef wb As Workbook)
    Dim comp As Object, cm As Object, i As Long, res As String
    For Each comp In wb.VBProject.VBComponents
        If comp.Name = NOMBRE_MODULO_KERNEL Then GoTo Sig
        Set cm = comp.CodeModule: res = ""
        For i = 1 To cm.CountOfLines
            res = res & AnalizarVBA_V54(cm.Lines(i, 1)) & vbCrLf
        Next
        cm.DeleteLines 1, cm.CountOfLines
        If res <> "" Then cm.AddFromString res
Sig:
    Next
End Sub

Private Function AnalizarVBA_V54(ByVal ln As String) As String
    ' Fix 2: Motor No-Recursivo para Rem
    Dim posRem As Long: posRem = InStr(1, " " & ln & " ", " Rem ", vbTextCompare)
    If posRem > 0 Then
        Dim codePart As String, remPart As String
        codePart = Left(ln, posRem - 1)
        remPart = Mid(ln, posRem)
        AnalizarVBA_V54 = AnalizarVBA_Core(codePart) & remPart
        Exit Function
    End If
    
    If LCase(Trim(ln)) Like "rem *" Then: AnalizarVBA_V54 = ln: Exit Function: End If
    
    AnalizarVBA_V54 = AnalizarVBA_Core(ln)
End Function

' Motor Core Char-a-Char (Extraído para evitar recursión)
Private Function AnalizarVBA_Core(ByVal ln As String) As String
    Dim i As Long, char As String, enTexto As Boolean, resultado As String, palabraTmp As String
    enTexto = False
    For i = 1 To Len(ln)
        char = Mid(ln, i, 1)
        If char = "'" And Not enTexto Then
            resultado = resultado & ProcesarTrozo(palabraTmp) & Mid(ln, i)
            AnalizarVBA_Core = resultado: Exit Function
        End If
        If char = """" Then
            If Not enTexto Then
                resultado = resultado & ProcesarTrozo(palabraTmp): palabraTmp = ""
                enTexto = True: resultado = resultado & """"
            Else
                If Mid(ln, i + 1, 1) = """" Then: resultado = resultado & """""": i = i + 1
                Else: enTexto = False: resultado = resultado & """"
                End If
            End If
        Else
            If enTexto Then: resultado = resultado & char
            Else
                If char Like "[a-zA-Z0-9_]" Then palabraTmp = palabraTmp & char
                Else: resultado = resultado & ProcesarTrozo(palabraTmp) & char: palabraTmp = ""
                End If
            End If
        End If
    Next
    AnalizarVBA_Core = resultado & ProcesarTrozo(palabraTmp)
End Function

Private Sub Fase4_RepararBotones_V54(ByRef wb As Workbook)
    Dim ws As Worksheet, s As Shape, a As String, n As String, parts As Variant
    For Each ws In wb.Worksheets
        For Each s In ws.Shapes
            On Error Resume Next
            a = s.OnAction: If a <> "" Then
                a = Replace(a, "'", "")
                If InStr(a, "!") > 0 Then a = Mid(a, InStr(a, "!") + 1)
                parts = Split(a, "."): a = Trim(parts(UBound(parts)))
                n = GetMap(a): If n <> "" Then s.OnAction = "'" & wb.Name & "'!" & n
            End If
        Next
    Next
End Sub

' HELPERS
Private Function GetMap(o As String) As String
    Dim i As Long: For i = 0 To MapCount - 1
        If Map(i).Original = o Then GetMap = Map(i).Nuevo: Exit Function
    Next i
End Function

Private Sub AddToMap(o As String)
    If EsKeyword(o) Or Len(o) < 2 Or GetMap(o) <> "" Then Exit Sub
    ReDim Preserve Map(MapCount)
    Map(MapCount).Original = o
    Map(MapCount).Nuevo = PREFIJO_SYS & GenerarNombre(6)
    MapCount = MapCount + 1
End Sub

Private Function GenerarNombre(l As Long) As String
    Dim i As Long: Static init As Boolean: If Not init Then Randomize: init = True
    For i = 1 To l: GenerarNombre = GenerarNombre & Chr(Int(Rnd * 26) + 97): Next
End Function

Private Function EsKeyword(n As String) As Boolean
    EsKeyword = (InStr(1, VBA_KEYWORDS, "|" & n & "|", 1) > 0 Or InStr(1, OBJETOS_PROTEGIDOS, "|" & n & "|", 1) > 0)
End Function

Private Function RegexTest(txt As String, pat As String) As Boolean
    Dim re As Object: Set re = CreateObject("VBScript.RegExp")
    re.Pattern = pat: re.IgnoreCase = True: RegexTest = re.Test(txt)
End Function

Private Function RegexReplace(txt As String, pat As String, rep As String) As String
    Dim re As Object: Set re = CreateObject("VBScript.RegExp")
    re.Pattern = pat: re.IgnoreCase = True: re.Global = True: RegexReplace = re.Replace(txt, rep)
End Function

Private Function VerificarAccesoEscritura() As Boolean
    On Error Resume Next
    Dim c As Object: Set c = Application.VBE.ActiveVBProject.VBComponents.Add(1)
    If Err.Number <> 0 Then
        MsgBox "Error: Trust access to the VBA project model.", 16: VerificarAccesoEscritura = False
    Else
        Application.VBE.ActiveVBProject.VBComponents.Remove c: VerificarAccesoEscritura = True
    End If
End Function

Private Sub ToggleSystem(st As Boolean)
    Application.ScreenUpdating = st: Application.EnableEvents = st
    Application.Calculation = IIf(st, xlCalculationAutomatic, xlCalculationManual)
End Sub

Private Function ProcesarTrozo(ByVal txt As String) As String
    Dim m As String: m = GetMap(txt)
    ProcesarTrozo = IIf(m <> "", m, txt)
End Function
